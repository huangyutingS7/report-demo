<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¶ æ´²è¨ˆç•« Oasis Projectï¼ˆ1~5é—œå®Œæ•´æ•´åˆç‰ˆ v8ï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { box-sizing: border-box; }
    body { font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    .glass { background: rgba(255,255,255,.78); backdrop-filter: blur(10px); }
    .shadow-soft { box-shadow: 0 10px 35px rgba(0,0,0,.10); }
    .card-hover { transition: transform .15s ease, box-shadow .15s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,.12); }

    #modal { z-index: 9999; }
    #jumpOverlay { z-index: 10100; }
    #celebrateOverlay { z-index: 10200; }

    .modal-backdrop { background: rgba(17,24,39,.55); }
    .pop-overlay { animation: popIn .25s ease both; }
    @keyframes popIn { from { transform: scale(.98); opacity: .0; } to { transform: scale(1); opacity: 1; } }

    /* coin pop */
    .coin-pop{
      position: fixed; right: 18px; top: 58px;
      z-index: 999999; font-weight: 900; pointer-events: none;
      animation: coinFly 1s ease forwards;
      text-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    @keyframes coinFly{
      0%{ transform: translateY(12px); opacity: 0; }
      15%{ opacity: 1; }
      100%{ transform: translateY(-38px); opacity: 0; }
    }

    /* Stage1 blocks */
    .blkA { border: 1px solid rgba(16,185,129,.20); background: linear-gradient(180deg, rgba(236,253,245,.9), rgba(255,255,255,.95)); }
    .blkB { border: 1px solid rgba(14,165,233,.20); background: linear-gradient(180deg, rgba(240,249,255,.95), rgba(255,255,255,.95)); }
    .blkC { border: 1px solid rgba(245,158,11,.18); background: linear-gradient(180deg, rgba(255,251,235,.95), rgba(255,255,255,.95)); }

    /* æ•™å­¸å¡æ›´æœ‰å±¤æ¬¡ */
    .teach-card {
      border: 1px solid rgba(15,23,42,.10);
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(16,185,129,.14), transparent 60%),
        radial-gradient(700px 200px at 90% 20%, rgba(59,130,246,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.98), rgba(248,250,252,.98));
      position: relative;
      overflow: hidden;
    }
    .teach-card:before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(200px 200px at 15% 30%, rgba(16,185,129,.10), transparent 65%),
        radial-gradient(240px 240px at 90% 30%, rgba(245,158,11,.10), transparent 70%);
      transform: rotate(6deg);
      pointer-events:none;
    }
    .teach-inner{ position:relative; }

    .choice-btn{
      border: 1px solid rgba(15,23,42,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(248,250,252,.98));
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .choice-btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,6,23,.08); border-color: rgba(15,23,42,.25); }
    .choice-strong{
      background: linear-gradient(180deg, rgba(224,231,255,.75), rgba(255,255,255,.98));
      border-color: rgba(99,102,241,.40);
    }

    /* Drama */
    .drama-stage{
      border: 1px solid rgba(2,132,199,.20);
      background: radial-gradient(1200px 500px at 50% 0%, rgba(14,165,233,.10), transparent 55%),
                  linear-gradient(180deg, rgba(240,249,255,.90), rgba(255,255,255,.98));
    }
    .actor-card{ border: 1px solid rgba(15,23,42,.10); background: rgba(255,255,255,.85); }
    .bubble{ border: 1px solid rgba(15,23,42,.12); background: rgba(255,255,255,.92); }
    .mouth{ transform-origin: center; }
    .talking .mouth{ animation: mouthTalk .16s ease-in-out infinite; }
    @keyframes mouthTalk{ 0%,100%{ transform: scaleY(.55);} 50%{ transform: scaleY(1.35);} }

    /* Deal animation (Stage2) */
    .deal-enter { animation: dealIn .28s ease both; transform-origin: 20% 0%; }
    @keyframes dealIn {
      from { transform: translateY(-10px) rotate(-2deg); opacity: 0; }
      to   { transform: translateY(0px) rotate(0deg); opacity: 1; }
    }

    header { backdrop-filter: blur(10px); }

    /* Stage1 å…§çš„å°è¦–çª— */
    .inner-modal-backdrop{ background: rgba(15,23,42,.45); }
    .inner-modal { z-index: 999999; }

    /* Stage4 zoom modal */
    #zoomModal { z-index: 10080; }

    /* âœ… å…¨ä»»å‹™å®Œæˆæ…¶ç¥ï¼šç”Ÿæ—¥å¸½ï¼‹çµ²å¸¶é£›è½ */
    #celebrateRain { position:absolute; inset:0; overflow:hidden; pointer-events:none; }
    .party-item{
      position:absolute; top:-40px;
      font-size: 26px;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.18));
      animation: partyFall linear forwards;
      will-change: transform, opacity;
      opacity: .95;
    }
    @keyframes partyFall{
      0%   { transform: translateY(-40px) rotate(0deg) scale(.95); opacity: 0; }
      10%  { opacity: 1; }
      100% { transform: translateY(120vh) rotate(520deg) scale(1.06); opacity: 1; }
    }

    /* =========================
       âœ… EcoCup ç•ªå¤–ç¯‡ï¼šå°å‹•ç•«ï¼ˆåƒ…æ–°å¢ï¼Œä¸å½±éŸ¿ 1~5 é—œï¼‰
    ========================= */
    @keyframes ecocupFadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes ecocupSlideIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes ecocupPulseOnce {
      0% { transform: scale(1); }
      55% { transform: scale(1.06); }
      100% { transform: scale(1); }
    }

    .ecocup-card { animation: ecocupFadeUp .35s ease both; }
    .eco-proto { animation: ecocupSlideIn .28s ease both; }

    .eco-choice{
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.92);
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    .eco-choice:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(2,6,23,.08);
      border-color: rgba(15,23,42,.22);
    }
    .eco-choice:active{ transform: scale(.97); }
    .eco-choice.selected{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.45);
      box-shadow: 0 10px 25px rgba(16,185,129,.10);
    }
    .eco-choice.pulse{ animation: ecocupPulseOnce .28s ease; }

    /* âœ… æš±ç¨±é–‹å§‹ç•«é¢ */
    #startOverlay { z-index: 20000; }

    /* âœ…ï¼ˆv8æ–°å¢ï¼‰Stage1ï¼šæ¯å¼µå¡å·¦å´èªéŸ³æŒ‰éˆ• */
    .voice-mini{
      width: 38px; height: 38px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.96);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .voice-mini:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(2,6,23,.08); border-color: rgba(15,23,42,.25); }
    .voice-mini:active{ transform: scale(.98); }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-sky-50 to-amber-50">

  <!-- âœ… Start Overlayï¼šæš±ç¨±åªè¼¸å…¥ä¸€æ¬¡ï¼ˆä¹‹å¾Œè‡ªå‹•è¨˜ä½ï¼‰ -->
  <div id="startOverlay" class="fixed inset-0 hidden items-center justify-center p-6">
    <div class="absolute inset-0 modal-backdrop"></div>

    <div class="relative w-full max-w-xl rounded-3xl bg-white border border-slate-200 shadow-soft p-6 pop-overlay">
      <div class="flex items-center gap-3">
        <div class="w-14 h-14 rounded-3xl bg-emerald-600 flex items-center justify-center text-white font-black shadow-soft">O</div>
        <div>
          <div class="text-xl font-black text-slate-900">ç¶ æ´²è¨ˆç•« Oasis Project</div>
          <div class="text-sm text-slate-600 mt-1">é–‹å§‹ä¹‹å‰ï¼Œå…ˆå‘Šè¨´æˆ‘ä½ çš„æš±ç¨± âœ¨</div>
        </div>
      </div>

      <div class="mt-5">
        <label class="text-sm font-extrabold text-slate-900">ä½ çš„æš±ç¨±</label>
        <input id="nicknameInput" type="text" class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-200"
          placeholder="ä¾‹å¦‚ï¼šå°å²± / Coco / Alexï¼ˆæƒ³è¼¸å…¥ä»€éº¼éƒ½å¯ä»¥ï¼‰" />
      </div>

      <div class="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-100 text-slate-800">
        <div class="text-sm font-extrabold">é–‹å§‹ <span id="nickPreview" class="text-emerald-700">å†’éšªè€…</span>ï¼Œæº–å‚™é–‹å§‹ä½ çš„å¥‡å¹»å†’éšªå§ï¼</div>
        <div class="text-xs text-slate-600 mt-1">ï¼ˆåªéœ€è¦è¼¸å…¥ä¸€æ¬¡ï¼Œä¹‹å¾Œæœƒè‡ªå‹•è¨˜ä½ï¼‰</div>
      </div>

      <button id="btnStartGame" class="mt-4 w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700">
        é€²å…¥éŠæˆ²
      </button>

      <div id="nickErr" class="mt-3 hidden text-sm font-bold text-rose-700"></div>
    </div>
  </div>

  <!-- Top Bar -->
  <header class="w-full px-4 sm:px-6 py-4 sticky top-0 z-[200]">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-black shadow-soft">O</div>
        <div>
          <div class="font-extrabold text-slate-900 leading-tight">ç¶ æ´²è¨ˆç•« Oasis Project</div>
          <div class="text-xs text-slate-600">1~5é—œï½œæ•´åˆç‰ˆ v7</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <!-- âœ… é¡¯ç¤ºæš±ç¨±ï¼ˆå¯æ›´æ”¹ï¼‰ -->
        <div class="px-3 py-2 rounded-2xl bg-white/85 border border-slate-200 shadow-soft flex items-center gap-2">
          <span class="text-lg">ğŸ‘‹</span>
          <div class="text-sm font-extrabold text-slate-900">ä½ å¥½ï¼Œ<span id="topNick">å†’éšªè€…</span></div>
          <button id="btnChangeNick" class="ml-1 px-2 py-1 rounded-xl bg-slate-900 text-white text-xs font-extrabold hover:bg-slate-800">
            æ›´æ”¹
          </button>
        </div>

        <button id="btnReset" class="px-3 py-2 rounded-xl bg-white/80 border border-slate-200 text-slate-700 text-sm font-semibold hover:bg-white shadow-soft">
          é‡ç½®é€²åº¦
        </button>

        <!-- âœ… å¸³æœ¬æŒ‰éˆ•å·²åˆªé™¤ -->

        <div class="px-4 py-2 rounded-2xl bg-white/85 border border-slate-200 shadow-soft flex items-center gap-3">
          <div class="w-9 h-9 rounded-2xl bg-amber-100 flex items-center justify-center">
            <span class="text-xl">ğŸ‘›</span>
          </div>
          <div class="leading-tight">
            <div class="text-[11px] text-slate-600 font-semibold">EcoCoin</div>
            <div class="text-lg font-black text-slate-900"><span id="ecoCoin">0</span></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="px-4 sm:px-6 pb-10">
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left -->
      <section class="lg:col-span-2">
        <div class="p-5 sm:p-6 rounded-3xl glass border border-white/60 shadow-soft">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-xl sm:text-2xl font-black text-slate-900">é—œå¡åœ°åœ–</h2>
              <p class="text-sm text-slate-600 mt-1">ç¬¬ 1 é—œå…ˆå»ºç«‹æ ¸å¿ƒçŸ¥è­˜ï¼Œå†é€²å…¥ 2~5 é—œã€‚</p>
            </div>
            <div class="text-xs text-slate-600 font-semibold bg-white/70 border border-white/80 px-3 py-2 rounded-xl">
              é€²åº¦ï¼š<span id="progressText">0/5</span>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4 items-stretch">
            <div class="p-4 rounded-2xl bg-white/75 border border-white/80 card-hover flex flex-col h-full">

              <div class="flex items-center justify-between">
                <div class="font-extrabold text-slate-900">ç¬¬ 1 é—œï½œçŸ¥è­˜å»ºç«‹ï¼‹å°åŠ‡å ´ï¼‹æƒ…å¢ƒ</div>
                <span id="badge1" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-bold">æœªå®Œæˆ</span>
              </div>
              <p class="text-sm text-slate-600 mt-2">éŒ¢åŒ… / NFT / RWA â†’ æ¯å¼µå¡éƒ½è¦ã€Œç­”ä¸€é¡Œã€ç¢ºèªç†è§£ã€‚</p>
              <button id="lv1" class="mt-3 w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700">
                é–‹å§‹ç¬¬ 1 é—œ
              </button>
            </div>

            <div class="p-4 rounded-2xl bg-white/75 border border-white/80 card-hover flex flex-col h-full">

              <div class="flex items-center justify-between">
                <div class="font-extrabold text-slate-900">ç¬¬ 2 é—œï½œNFT è¾¨è­˜ç¿»ç‰Œï¼ˆæ…¢æ…¢ç™¼ç‰Œï¼‰</div>
                <span id="badge2" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-bold">æœªè§£é–</span>
              </div>
              <p class="text-sm text-slate-600 mt-2">ï¼ˆä¾é™„åœ–ï¼‰æ¯å¼µå¡ç›´æ¥å¯«ã€Œæ˜¯ä»€éº¼ç‰Œã€ï¼Œåªæœ‰ä¸€å¼µå¯é©—è­‰ä¾†æºã€‚</p>
              <button id="lv2" class="mt-3 w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
                éœ€è¦å®Œæˆç¬¬ 1 é—œ
              </button>
            </div>

            <div class="p-4 rounded-2xl bg-white/75 border border-white/80 card-hover flex flex-col h-full">

              <div class="flex items-center justify-between">
                <div class="font-extrabold text-slate-900">ç¬¬ 3 é—œï½œåè©ç´…æ——åˆ†é¡ï¼ˆéŠæˆ²ï¼‰</div>
                <span id="badge3" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-bold">æœªè§£é–</span>
              </div>
              <p class="text-sm text-slate-600 mt-2">æŠŠå¡ç‰‡åˆ†åˆ°ã€Œå®‰å…¨ / å¯ç–‘ã€ï¼Œå…¨éƒ¨åˆ†å°å°±é€šé—œã€‚</p>
              <button id="lv3" class="mt-3 w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
                éœ€è¦å®Œæˆç¬¬ 2 é—œ
              </button>
            </div>

            <div class="p-4 rounded-2xl bg-white/75 border border-white/80 card-hover flex flex-col h-full">

              <div class="flex items-center justify-between">
                <div class="font-extrabold text-slate-900">ç¬¬ 4 é—œï½œå¯ç–‘äº¤æ˜“åµæ¸¬ï¼ˆæ”¾å¤§é¡ï¼‰</div>
                <span id="badge4" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-bold">æœªè§£é–</span>
              </div>
              <p class="text-sm text-slate-600 mt-2">æ”¾å¤§é¡æœƒã€Œè·³å‡ºå¯ç–‘ç´°ç¯€ã€â†’ ä½ å†é¸æœ€å¯ç–‘çš„ä¸€ç­†ã€‚</p>
              <button id="lv4" class="mt-3 w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
                éœ€è¦å®Œæˆç¬¬ 3 é—œ
              </button>
            </div>

            <div class="p-4 rounded-2xl bg-white/75 border border-white/80 card-hover flex flex-col h-full">
              <div class="flex items-center justify-between">
                <div class="font-extrabold text-slate-900">ç¬¬ 5 é—œï½œRWA å…¥é–€ï¼‹åˆ†é¡å°éŠæˆ²ï¼‹å…Œæ›</div>
                <span id="badge5" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-bold">æœªè§£é–</span>
              </div>
              <p class="text-sm text-slate-600 mt-2">ï¼ˆåš´æ ¼éµå®ˆï¼‰é€šé—œæ™‚åŠ ä¸Š YA éŸ³æ•ˆã€‚</p>
              <button id="lv5" class="mt-3 w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
                éœ€è¦å®Œæˆç¬¬ 4 é—œ
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Right -->
      <aside class="lg:col-span-1">
        <div class="p-5 sm:p-6 rounded-3xl glass border border-white/60 shadow-soft">
          <h3 class="text-lg font-black text-slate-900">ç‹€æ…‹ä¸­å¿ƒ</h3>

          <div class="mt-4 p-4 rounded-2xl bg-white/75 border border-white/80">
            <div class="flex items-center justify-between">
              <div class="font-extrabold text-slate-900">Green ID Badgeï¼ˆSBTï¼‰</div>
              <span class="text-xs font-bold px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">è‡ªå‹•æ›´æ–°</span>
            </div>
            <p class="text-sm text-slate-600 mt-2">å®Œæˆ 1~4 é—œæœƒäº®ï¼Œå±•ç¤ºå­¸ç¿’é€²åº¦ã€‚</p>

            <div class="mt-3 grid grid-cols-4 gap-2">
              <div id="sbt1" class="p-2 rounded-xl bg-slate-100 text-center text-xs font-black text-slate-500">1</div>
              <div id="sbt2" class="p-2 rounded-xl bg-slate-100 text-center text-xs font-black text-slate-500">2</div>
              <div id="sbt3" class="p-2 rounded-xl bg-slate-100 text-center text-xs font-black text-slate-500">3</div>
              <div id="sbt4" class="p-2 rounded-xl bg-slate-100 text-center text-xs font-black text-slate-500">4</div>
            </div>
          </div>

          <div class="mt-4 p-4 rounded-2xl bg-white/75 border border-white/80">
            <div class="font-extrabold text-slate-900">æç¤º</div>
            <p class="text-sm text-slate-600 mt-2">
              è‹¥èªéŸ³æ²’è²ï¼šå…ˆé»ä»»æ„æŒ‰éˆ•ä¸€æ¬¡ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰ï¼Œå†åˆ°ç¬¬ 1 é—œå¡ç‰‡å·¦å´æŒ‰ ğŸ”Šï¼ˆé è¨­å·²é–‹ï¼‰ã€‚
            </p>
          </div>

          <!-- âœ… EcoCup ç•ªå¤–ç¯‡å…¥å£ï¼ˆå³å´ç‹€æ…‹ä¸­å¿ƒï¼Œåƒ…æ–°å¢ï¼‰ -->
          <div class="mt-4 p-4 rounded-2xl bg-white/75 border border-white/80 ecocup-card">
            <div class="flex items-center justify-between gap-2">
              <div class="font-extrabold text-slate-900">EcoCupï½œæ‰‹æå‹å–„è¨­è¨ˆ</div>
              <span class="text-xs font-bold px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">ç•ªå¤–ç¯‡</span>
            </div>
            <p class="text-sm text-slate-600 mt-2">
              ä¸æ”¹ä½ åŸæœ¬äº”é—œï¼Œåªé¡å¤–å±•ç¤ºï¼šå¦‚ä½•è¨­è¨ˆä¸€æ¬¾ã€Œå¤§å®¶éƒ½é¡˜æ„æ–¹ä¾¿æåœ¨æ‰‹ä¸Šã€çš„ç’°ä¿æ¯ã€‚
            </p>
            <button id="btnEcoCupIdea"
              class="mt-3 w-full px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-slate-800">
              çœ‹è¨­è¨ˆåŸå‹
            </button>
          </div>

        </div>
      </aside>

    </div>
  </main>

  <!-- Main Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative w-full max-w-3xl max-h-[88vh] rounded-3xl bg-white shadow-soft border border-white/60 overflow-hidden flex flex-col pop-overlay">
      <div class="px-5 sm:px-6 py-4 bg-gradient-to-r from-emerald-600 to-sky-600 text-white">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="modalTitle" class="text-lg sm:text-xl font-black">é—œå¡</div>
            <div id="modalSubtitle" class="text-xs sm:text-sm text-white/90 mt-1">å‰¯æ¨™</div>
          </div>
          <button id="modalClose" class="w-10 h-10 rounded-2xl bg-white/15 hover:bg-white/25 flex items-center justify-center font-black">âœ•</button>
        </div>
      </div>

      <div id="modalBody" class="px-5 sm:px-6 py-5 overflow-y-auto" style="max-height: calc(88vh - 110px);"></div>
    </div>
  </div>

  <!-- Jump Overlay -->
  <div id="jumpOverlay" class="fixed inset-0 hidden items-center justify-center p-6">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative w-full max-w-lg rounded-3xl bg-white border border-slate-200 shadow-soft p-6 pop-overlay">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 rounded-3xl bg-amber-100 flex items-center justify-center text-3xl">ğŸ§­</div>
        <div>
          <div id="jumpTitle" class="text-lg font-black text-slate-900">åšå¾—å¥½ï¼</div>
          <div id="jumpSub" class="text-sm text-slate-600 mt-1">ä½ å¯ä»¥çœ‹å®Œå†ç¹¼çºŒ</div>
        </div>
      </div>

      <div class="mt-4 bg-emerald-50 border border-emerald-100 rounded-2xl p-4">
        <div class="text-sm font-extrabold text-slate-900">å­¸ç¿’æˆæœå¡</div>
        <div id="jumpLearn" class="text-sm text-slate-800 mt-2 leading-relaxed"></div>
      </div>

      <div class="mt-3 bg-slate-50 border border-slate-200 rounded-2xl p-4">
        <div class="text-sm font-extrabold text-slate-900">å°æé†’</div>
        <div id="jumpTip" class="text-sm text-slate-700 mt-1">æç¤ºæ–‡å­—</div>
      </div>

      <button id="jumpGo" class="mt-4 w-full px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-slate-800">
        ç¹¼çºŒ
      </button>
    </div>
  </div>

  <!-- âœ… Celebrate Overlay -->
  <div id="celebrateOverlay" class="fixed inset-0 hidden items-center justify-center p-6">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div id="celebrateRain"></div>

    <div class="relative w-full max-w-xl rounded-3xl bg-white border border-slate-200 shadow-soft p-6 pop-overlay">
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-14 h-14 rounded-3xl bg-amber-100 flex items-center justify-center text-3xl">ğŸ¥³</div>
          <div>
            <div class="text-xl font-black text-slate-900">æ­å–œä½ å®Œæˆæ‰€æœ‰ä»»å‹™ï¼</div>
            <div class="text-sm text-slate-600 mt-1">ä½ å·²é€šé—œ 1ï½5 é—œ âœ…</div>
          </div>
        </div>
        <button id="celebrateClose" class="w-10 h-10 rounded-2xl bg-slate-900 text-white font-black hover:bg-slate-800">âœ•</button>
      </div>

      <div class="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-100 text-slate-800 text-sm leading-relaxed">
        å¤ªæ£’äº†ï¼ä½ å·²ç¶“å­¸æœƒï¼š<br/>
        <b>éŒ¢åŒ…</b>ï¼ˆè‡ªå·±æŒæ§æˆæ¬Šï¼‰ã€<b>NFT</b>ï¼ˆçœ‹ä¾†æºå¯é©—è­‰ï¼‰ã€<b>RWA</b>ï¼ˆçœŸå¯¦ä¸–ç•Œè³‡ç”¢/æ¬Šç›Šæ†‘è­‰ï¼‰<br/>
        ä¹Ÿèƒ½è¾¨è­˜å¸¸è¦‹è©é¨™è¨Šè™Ÿï¼šæ€¥è¿«ã€å…ˆä»˜è²»ã€ç„¡é™é¡ã€ç¸®ç¶²å€ã€‚
      </div>

      <button id="celebrateOk" class="mt-4 w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700">
        æˆ‘çŸ¥é“äº†
      </button>
    </div>
  </div>

  <!-- Stage4 Zoom Modal -->
  <div id="zoomModal" class="fixed inset-0 hidden items-center justify-center p-6">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative w-full max-w-lg rounded-3xl bg-white border border-slate-200 shadow-soft p-5 pop-overlay">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div id="zoomTitle" class="text-lg font-black text-slate-900">æ”¾å¤§é¡</div>
          <div id="zoomSub" class="text-sm text-slate-600 mt-1">å¯ç–‘ç´°ç¯€</div>
        </div>
        <button id="zoomClose" class="w-10 h-10 rounded-2xl bg-slate-900 text-white font-black hover:bg-slate-800">âœ•</button>
      </div>
      <div id="zoomBody" class="mt-4 p-4 rounded-2xl bg-slate-50 border border-slate-200 text-slate-800 text-sm leading-relaxed"></div>
      <button id="zoomOk" class="mt-4 w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700">çŸ¥é“äº†</button>
    </div>
  </div>

<script>
/* =========================
   âœ… Nickname (input once)
========================= */
const NICK_KEY = "oasis_nickname_v1";

function getNick(){
  const n = localStorage.getItem(NICK_KEY);
  return (n && n.trim()) ? n.trim() : "";
}
function setNick(n){
  localStorage.setItem(NICK_KEY, (n || "").trim());
}
function applyNickToUI(){
  const n = getNick() || "å†’éšªè€…";
  const top = document.getElementById("topNick");
  if(top) top.textContent = n;
}
function showStartOverlay(){
  const ov = document.getElementById("startOverlay");
  if(!ov) return;
  ov.classList.remove("hidden");
  ov.classList.add("flex");

  const input = document.getElementById("nicknameInput");
  const prev  = document.getElementById("nickPreview");
  const err   = document.getElementById("nickErr");
  if(err){ err.classList.add("hidden"); err.textContent = ""; }

  if(input){
    input.value = "";
    input.focus();
    input.addEventListener("input", ()=>{
      if(prev) prev.textContent = input.value.trim() || "å†’éšªè€…";
    }, { passive:true });
  }
}
function hideStartOverlay(){
  const ov = document.getElementById("startOverlay");
  if(!ov) return;
  ov.classList.add("hidden");
  ov.classList.remove("flex");
}

/* =========================
   Storage / State
========================= */
const STORAGE_KEY = "oasis_full_1to5_state_v7";
const defaultState = () => ({
  eco: 0,
  completed: {1:false,2:false,3:false,4:false,5:false},
  celebratedAllDone: false, // å…¨é€šé—œå¿«æ¨‚éŸ³æ•ˆåªæ’­ä¸€æ¬¡
});
let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    if(!s || typeof s !== "object") return defaultState();
    if(typeof s.eco !== "number") s.eco = 0;
    if(!s.completed) s.completed = {1:false,2:false,3:false,4:false,5:false};
    if(typeof s.celebratedAllDone !== "boolean") s.celebratedAllDone = false;
    return s;
  }catch(e){ return defaultState(); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* =========================
   DOM Helpers
========================= */
const $ = (id) => document.getElementById(id);
function setText(id, t){ $(id).textContent = t; }
function show(el){ el.classList.remove("hidden"); el.classList.add("flex"); }
function hide(el){ el.classList.add("hidden"); el.classList.remove("flex"); }

/* =========================
   EcoCoin
========================= */
function renderEco(){ setText("ecoCoin", String(state.eco)); }
function coinFly(amount){
  const el = document.createElement("div");
  el.className = "coin-pop text-amber-300";
  el.textContent = `+${amount}`;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 1100);
}
function addEco(amount, detail){
  state.eco += amount;
  renderEco();
  coinFly(amount);
  saveState();
}
function spendEco(amount, detail){
  if(state.eco < amount) return false;
  state.eco -= amount;
  renderEco();
  saveState();
  return true;
}

/* =========================
   SFX (WebAudio)
========================= */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(AC) audioCtx = new AC();
  }
  if(audioCtx && audioCtx.state === "suspended"){
    audioCtx.resume().catch(()=>{});
  }
}
function beep(freq=440, dur=0.08, type="sine", gain=0.06){
  ensureAudio();
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}
function noiseBurst(dur=0.12, gain=0.05){
  ensureAudio();
  if(!audioCtx) return;
  const bufferSize = Math.floor(audioCtx.sampleRate * dur);
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<bufferSize;i++){
    data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
  }
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  const g = audioCtx.createGain();
  g.gain.value = gain;
  src.connect(g); g.connect(audioCtx.destination);
  src.start();
  src.stop(audioCtx.currentTime + dur);
}
function sfxFlip(){ beep(520, .06, "square", .04); beep(740, .05, "square", .03); }
function sfxBad(){ beep(180, .10, "sawtooth", .05); }
function sfxGood(){ beep(660, .08, "sine", .06); beep(880, .10, "sine", .05); }
function sfxLevelUp(){
  beep(523.25, .08, "sine", .05);
  setTimeout(()=>beep(659.25, .08, "sine", .05), 90);
  setTimeout(()=>beep(783.99, .10, "sine", .055), 180);
  setTimeout(()=>beep(1046.5, .12, "sine", .06), 280);
}
function sfxEncourage(){
  beep(392.0, .07, "sine", .04);
  setTimeout(()=>beep(440.0, .07, "sine", .04), 110);
  setTimeout(()=>beep(523.25, .09, "sine", .045), 220);
}
/* YAï¼ˆç¬¬äº”é—œæ­å–œéŸ³æ•ˆï¼‰ */
function sfxYA(){
  beep(659.25, .07, "sine", .05);
  setTimeout(()=>beep(783.99, .07, "sine", .05), 70);
  setTimeout(()=>beep(987.77, .10, "sine", .055), 140);
}
/* å…¨ä»»å‹™å®Œæˆï¼šå¾ˆé–‹å¿ƒçš„ã€Œè€¶ï¼ã€éŸ³æ•ˆ */
function sfxAllDoneCheer(){
  const notes = [523.25, 659.25, 783.99, 1046.5, 1318.5];
  notes.forEach((f, i)=> setTimeout(()=>beep(f, 0.10, "sine", 0.055), i*90));
  setTimeout(()=>{ beep(1046.5, 0.14, "triangle", 0.06); beep(1318.5, 0.14, "triangle", 0.05); }, 430);
  setTimeout(()=>noiseBurst(0.10, 0.05), 520);
  setTimeout(()=>noiseBurst(0.10, 0.05), 650);
  setTimeout(()=>noiseBurst(0.14, 0.05), 800);
}

/* =========================
   TTS
========================= */
/* âœ…ï¼ˆv8è®Šæ›´ï¼‰é è¨­é–‹å•Ÿè²éŸ³ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å¯å†é—œé–‰ */
let SOUND_ON = true;      // ç¬¬1é—œå¡ç‰‡å·¦å´æ§åˆ¶ï¼ˆå–ä»£å³ä¸Šè§’ï¼‰
let ttsVoice = null;

function initTTS(){
  if(!("speechSynthesis" in window)) return;
  const pickVoice = () => {
    const voices = window.speechSynthesis.getVoices() || [];
    ttsVoice = voices.find(v => v.lang === "zh-TW") || voices.find(v => v.lang && v.lang.startsWith("zh")) || null;
  };
  pickVoice();
  window.speechSynthesis.onvoiceschanged = pickVoice;
}
function stopTTS(){
  if(!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
}
function speakOnce(text, opts={}){
  if(!SOUND_ON) return null;
  if(!("speechSynthesis" in window)) return null;
  stopTTS();
  const u = new SpeechSynthesisUtterance(text);
  if(ttsVoice) u.voice = ttsVoice;
  u.lang = (ttsVoice && ttsVoice.lang) ? ttsVoice.lang : "zh-TW";
  u.rate = opts.rate ?? 1.02;
  u.pitch = opts.pitch ?? 1.0;
  window.speechSynthesis.speak(u);
  return u;
}
initTTS();

/* =========================
   Modal
========================= */
function openModal(title, subtitle){
  setText("modalTitle", title);
  setText("modalSubtitle", subtitle || "");
  $("modalBody").innerHTML = "";
  show($("modal"));
}
function closeModal(){
  hide($("modal"));
  stopTTS();
}
function bodyHTML(html){ $("modalBody").innerHTML = html; }

/* =========================
   Unlock / Badges / Buttons
========================= */
function setBadge(id, text, cls){
  const b = $(id);
  b.textContent = text;
  b.className = `text-xs px-2 py-1 rounded-full font-bold ${cls}`;
}
function setSBT(id, on, icon){
  const el = $(id);
  if(on){
    el.className = "p-2 rounded-xl bg-emerald-600 text-center text-xs font-black text-white";
    el.textContent = icon;
  }else{
    el.className = "p-2 rounded-xl bg-slate-100 text-center text-xs font-black text-slate-500";
    el.textContent = id.replace("sbt","");
  }
}
function setLevelButton(level, enabled, label){
  const btn = $("lv"+level);
  btn.textContent = label;
  if(enabled){
    btn.className = "mt-3 w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700";
    btn.disabled = false;
  }else{
    btn.className = "mt-3 w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed";
    btn.disabled = true;
  }
}
function updateBadges(){
  const c = state.completed;
  setBadge("badge1", c[1] ? "å·²å®Œæˆ" : "æœªå®Œæˆ", c[1] ? "bg-emerald-50 text-emerald-700 border border-emerald-100" : "bg-slate-100 text-slate-600");
  setBadge("badge2", c[2] ? "å·²å®Œæˆ" : (c[1] ? "å¯é–‹å§‹" : "æœªè§£é–"), c[2] ? "bg-emerald-50 text-emerald-700 border border-emerald-100" : (c[1] ? "bg-sky-50 text-sky-700 border border-sky-100" : "bg-slate-100 text-slate-600"));
  setBadge("badge3", c[3] ? "å·²å®Œæˆ" : (c[2] ? "å¯é–‹å§‹" : "æœªè§£é–"), c[3] ? "bg-emerald-50 text-emerald-700 border border-emerald-100" : (c[2] ? "bg-sky-50 text-sky-700 border border-sky-100" : "bg-slate-100 text-slate-600"));
  setBadge("badge4", c[4] ? "å·²å®Œæˆ" : (c[3] ? "å¯é–‹å§‹" : "æœªè§£é–"), c[4] ? "bg-emerald-50 text-emerald-700 border border-emerald-100" : (c[3] ? "bg-sky-50 text-sky-700 border border-sky-100" : "bg-slate-100 text-slate-600"));
  setBadge("badge5", c[5] ? "å·²å®Œæˆ" : (c[4] ? "å¯é–‹å§‹" : "æœªè§£é–"), c[5] ? "bg-emerald-50 text-emerald-700 border border-emerald-100" : (c[4] ? "bg-sky-50 text-sky-700 border border-sky-100" : "bg-slate-100 text-slate-600"));

  setLevelButton(1, true, c[1] ? "å·²å®Œæˆï¼ˆå¯é‡ç©ï¼‰" : "é–‹å§‹ç¬¬ 1 é—œ");
  setLevelButton(2, c[1], c[2] ? "å·²å®Œæˆï¼ˆå¯é‡ç©ï¼‰" : "é–‹å§‹ç¬¬ 2 é—œ");
  setLevelButton(3, c[2], c[3] ? "å·²å®Œæˆï¼ˆå¯é‡ç©ï¼‰" : "é–‹å§‹ç¬¬ 3 é—œ");
  setLevelButton(4, c[3], c[4] ? "å·²å®Œæˆï¼ˆå¯é‡ç©ï¼‰" : "é–‹å§‹ç¬¬ 4 é—œ");
  setLevelButton(5, c[4], c[5] ? "å·²å®Œæˆï¼ˆå¯é‡ç©ï¼‰" : "é–‹å§‹ç¬¬ 5 é—œ");

  const doneCount = [1,2,3,4,5].filter(i=>c[i]).length;
  setText("progressText", `${doneCount}/5`);

  setSBT("sbt1", c[1], "ğŸŒ±");
  setSBT("sbt2", c[2], "ğŸ¥¤");
  setSBT("sbt3", c[3], "ğŸ›¡ï¸");
  setSBT("sbt4", c[4], "ğŸ”");
}
function markCompleted(level){
  if(!state.completed[level]){
    state.completed[level] = true;
    saveState();
  }
  updateBadges();

  const allDone = [1,2,3,4,5].every(k => state.completed[k]);
  if(allDone && !state.celebratedAllDone){
    state.celebratedAllDone = true;
    saveState();
    sfxAllDoneCheer();
  }
}

/* =========================
   æˆæœå¡
========================= */
const LEARN = {
  1: [
    "ğŸ‘› éŒ¢åŒ…ï¼šä½ è‡ªå·±æŒæ§æˆæ¬Šï¼Œä¸è¦æŠŠå¯†ç¢¼äº¤å‡ºå»ã€‚",
    "ğŸ§¾ NFTï¼šé‡é»æ˜¯ã€Œä¾†æº/åˆç´„å¯é©—è­‰ã€ï¼Œä¸æ˜¯åœ–ç‰‡åƒä¸åƒã€‚",
    "ğŸ  RWAï¼šæŠŠçœŸå¯¦ä¸–ç•Œè³‡ç”¢/æ¬Šç›Šåšæˆå¯é©—è­‰çš„æ•¸ä½æ†‘è­‰ã€‚"
  ],
  2: [
    "ğŸ¥¤ çœ‹ã€ç‰Œåã€åªæ˜¯æç¤ºï¼ŒçœŸæ­£è¦åœ¨æ„çš„æ˜¯ã€Œä¾†æº/åˆç´„è³‡è¨Šã€ã€‚",
    "âš ï¸ æ€¥è¿«å­—çœ¼ï¼‹è¦ä½ å…ˆä»˜/å…ˆç°½ï¼Œæ˜¯å¸¸è¦‹é‡£é­šå¥—è·¯ã€‚"
  ],
  3: [
    "ğŸ›¡ï¸ ç´…æ——åˆ†é¡ï¼šæ€¥è¿«ã€ç¸®ç¶²å€ã€è¦å…ˆä»˜è²»ã€è¦ç°½å/ç„¡é™é¡ â†’ å¤šåŠå¯ç–‘ã€‚",
    "âœ… çœŸçš„æ´»å‹•é€šå¸¸èƒ½åœ¨å®˜æ–¹ç¤¾ç¾¤/å®˜ç¶²æ‰¾åˆ°å°æ‡‰å…¬å‘Šã€‚"
  ],
  4: [
    "ğŸ” å¯ç–‘äº¤æ˜“ï¼šç„¡é™é¡ã€é™Œç”Ÿç¶²åŸŸã€æ€¥è¿«å­—çœ¼ã€è¦å…ˆä»˜è²»ã€‚",
    "ğŸ§  æ”¾å¤§é¡æ‰¾å‡ºã€è—åœ¨ç´°ç¯€è£¡ã€çš„é¢¨éšªã€‚"
  ],
  5: [
    "ğŸ  RWAï¼šçœŸå¯¦ä¸–ç•Œçš„æ±è¥¿ç”¨æ›´å¥½ç®¡ç†çš„æ–¹å¼æ¬åˆ°éˆä¸Šã€‚",
    "ğŸ¯ å…ˆåˆ†æ¸…æ¥šæ˜¯ä¸æ˜¯ RWAï¼Œå†è«‡å…Œæ›èˆ‡ä½¿ç”¨ã€‚"
  ],
};
function learnHTML(level){
  const lines = LEARN[level] || ["å®Œæˆä¸€é—œï¼Œå­¸æœƒä¸€å€‹æ¦‚å¿µã€‚"];
  return `<ul class="list-disc pl-5 space-y-1">${lines.map(x=>`<li>${x}</li>`).join("")}</ul>`;
}

/* =========================
   Jump Overlay
========================= */
let jumpNextFn = null;
let jumpAutoTimer = null;

function jumpTo(nextLevel, completedLevel){
  const tips = {
    2: "æç¤ºï¼šç¬¬ 2 é—œæ¯å¼µå¡æœƒå¯«æ˜¯ä»€éº¼ç‰Œï¼Œåªæœ‰ä¸€å¼µå¯é©—è­‰ä¾†æºã€‚",
    3: "æç¤ºï¼šç¬¬ 3 é—œæ˜¯ç´…æ——åˆ†é¡ï¼šå®‰å…¨ / å¯ç–‘ã€‚",
    4: "æç¤ºï¼šç¬¬ 4 é—œå…ˆç”¨æ”¾å¤§é¡çœ‹ç´°ç¯€ï¼Œå†é¸æœ€å¯ç–‘çš„ä¸€ç­†ã€‚",
    5: "æç¤ºï¼šç¬¬ 5 é—œé€šé—œæœƒæœ‰ YA éŸ³æ•ˆã€‚"
  };
  setText("jumpTitle", `åšå¾—å¥½ï¼å‰å¾€ç¬¬ ${nextLevel} é—œï¼`);
  setText("jumpSub", "ä½ å¯ä»¥çœ‹å®Œå†ç¹¼çºŒ");
  $("jumpTip").textContent = tips[nextLevel] || "ä¸€èµ·æŠŠæ¦‚å¿µç”¨éŠæˆ²å­¸æœƒã€‚";
  $("jumpLearn").innerHTML = learnHTML(completedLevel || (nextLevel-1));
  jumpNextFn = ()=> {
    hide($("jumpOverlay"));
    const fn = stages[`stage${nextLevel}`];
    if(fn) fn();
  };
  show($("jumpOverlay"));
  if(jumpAutoTimer) clearTimeout(jumpAutoTimer);
  jumpAutoTimer = setTimeout(()=>{
    if(jumpNextFn) jumpNextFn();
  }, 2600);
}
$("jumpGo").addEventListener("click", ()=>{
  if(jumpAutoTimer) clearTimeout(jumpAutoTimer);
  if(jumpNextFn) jumpNextFn();
});

/* =========================
   âœ… Celebration (birthday hats + ribbons falling)
========================= */
let partyTimer = null;
function clearParty(){
  const rain = $("celebrateRain");
  if(rain) rain.innerHTML = "";
  if(partyTimer) { clearTimeout(partyTimer); partyTimer = null; }
}
function openCelebrate(){
  clearParty();
  show($("celebrateOverlay"));
  startPartyRain();
  partyTimer = setTimeout(()=> closeCelebrate(), 5200);
}
function closeCelebrate(){
  hide($("celebrateOverlay"));
  clearParty();
}
$("celebrateClose").addEventListener("click", closeCelebrate);
$("celebrateOk").addEventListener("click", closeCelebrate);

function startPartyRain(){
  const rain = $("celebrateRain");
  const emojis = ["ğŸ¥³","ğŸ‰","ğŸŠ","ğŸ€","ğŸˆ","ğŸ","ğŸ§"];
  const count = 46;

  for(let i=0;i<count;i++){
    const el = document.createElement("div");
    el.className = "party-item";
    el.textContent = emojis[Math.floor(Math.random()*emojis.length)];

    const left = Math.random()*100;
    const delay = Math.random()*0.9;
    const dur = 2.8 + Math.random()*2.4;
    const size = 18 + Math.random()*20;
    const drift = (Math.random()*2 - 1) * 120;

    el.style.left = left + "vw";
    el.style.animationDuration = dur + "s";
    el.style.animationDelay = delay + "s";
    el.style.fontSize = size + "px";

    el.animate(
      [
        { transform: `translateY(-40px) translateX(0px) rotate(0deg) scale(.95)`, opacity: 0 },
        { transform: `translateY(10vh) translateX(${drift*0.25}px) rotate(120deg) scale(1.0)`, opacity: 1, offset: 0.25 },
        { transform: `translateY(120vh) translateX(${drift}px) rotate(520deg) scale(1.06)`, opacity: 1 }
      ],
      { duration: dur*1000, delay: delay*1000, easing: "linear", fill: "forwards" }
    );

    rain.appendChild(el);
    setTimeout(()=> el.remove(), (dur + delay)*1000 + 200);
  }
}

/* =========================
   Stage1
========================= */
function stage1(){
  openModal("ç¬¬ 1 é—œï½œå…ˆå»ºç«‹çŸ¥è­˜èªçŸ¥", "å®Œæˆ 3 å¼µå¡ï¼ˆæ¯å¼µç­”ä¸€é¡Œï¼‰ï¼‹å°åŠ‡å ´æ’­æ”¾å®Œï¼‹æƒ…å¢ƒç­”å° â†’ å‰å¾€ç¬¬ 2 é—œï¼ˆ+80ï¼‰");

  const cards = [
    {
      icon:"ğŸ‘›",
      title:"åŠ å¯†éŒ¢åŒ…æ˜¯ä»€éº¼ï¼Ÿ",
      core:"éŒ¢åŒ…å°±åƒä½ çš„æ•¸ä½çš®å¤¾ï¼šä½ è‡ªå·±ä¿ç®¡ï¼Œæ±ºå®šè¦ä¸è¦æˆæ¬Šã€‚",
      detail:[
        "ä½ å¯ä»¥æŠŠéŒ¢åŒ…æƒ³æˆã€Œé‘°åŒ™ï¼‹ä¿éšªç®±ã€ã€‚é‘°åŒ™ï¼ˆç§é‘°/åŠ©è¨˜è©ï¼‰åªçµ¦è‡ªå·±ï¼Œä¸çµ¦ä»»ä½•äººã€‚",
        "ç¶²ç«™è·³å‡ºç°½å/æˆæ¬Šè¦–çª—æ™‚ï¼Œä½ æ˜¯åœ¨ã€åŒæ„åšä¸€ä»¶äº‹ã€ï¼Œä¸æ˜¯ã€åªæ˜¯ç™»å…¥ã€ã€‚",
        "å®‰å…¨åŸå‰‡ï¼šçœ‹ä¸æ‡‚å°±å…ˆæ‹’çµ•ï¼Œå»å®˜æ–¹ç¢ºèªå†æ“ä½œã€‚"
      ].join("\n"),
      quiz:{
        q:"å“ªä¸€å¥æœ€æ­£ç¢ºï¼Ÿ",
        a:[
          {t:"éŒ¢åŒ…å¯†ç¢¼å¯ä»¥äº¤çµ¦ç¶²ç«™å¹«æˆ‘ä¿ç®¡", ok:false},
          {t:"éŒ¢åŒ…è¦è‡ªå·±ä¿ç®¡ï¼Œæˆæ¬Šè¦çœ‹æ¸…æ¥š", ok:true}
        ]
      }
    },
    {
      icon:"ğŸ§¾",
      title:"NFT æ˜¯ä»€éº¼ï¼Ÿ",
      core:"NFT ä¸æ˜¯åœ–ç‰‡æœ¬èº«ï¼Œè€Œæ˜¯ã€Œå¯é©—è­‰ä¾†æºã€çš„æ•¸ä½æ†‘è­‰ã€‚",
      detail:[
        "NFT åƒã€Œå¸¶åºè™Ÿçš„è­‰æ˜æ›¸ã€ã€‚é‡é»æ˜¯ä¾†æº/åˆç´„èƒ½ä¸èƒ½é©—è­‰ã€‚",
        "åœ–ç‰‡å¾ˆåƒä¸ä»£è¡¨æ˜¯çœŸçš„ï¼Œé‡£é­šå¸¸ç”¨ã€ä¸€æ¨£çš„åœ–ã€é¨™ä½ é»é€£çµã€‚",
        "å®‰å…¨åŸå‰‡ï¼šå…ˆçœ‹å®˜æ–¹ä¾†æºã€åˆç´„ã€ç¶²åŸŸï¼›ä¸è¦è¢«ã€é™æ™‚ã€å‚¬ä¿ƒã€‚"
      ].join("\n"),
      quiz:{
        q:"åˆ¤æ–· NFT çœŸå‡çš„é‡é»æ˜¯ï¼Ÿ",
        a:[
          {t:"åœ–ç‰‡å¥½ä¸å¥½çœ‹", ok:false},
          {t:"ä¾†æº/åˆç´„èƒ½ä¸èƒ½é©—è­‰", ok:true}
        ]
      }
    },
    {
      icon:"ğŸ ",
      title:"RWA æ˜¯ä»€éº¼ï¼Ÿ",
      core:"RWA æ˜¯æŠŠçœŸå¯¦ä¸–ç•Œçš„è³‡ç”¢/æ¬Šç›Šï¼Œåšæˆå¯é©—è­‰çš„æ•¸ä½æ†‘è­‰ã€‚",
      detail:[
        "RWA å¯ç†è§£ç‚ºï¼šæŠŠã€æˆ¿å±‹ã€ç¥¨åˆ¸ã€ä¿å›ºã€å‚µåˆ¸ã€ç­‰çœŸå¯¦ä¸–ç•Œæ¬Šç›Šï¼Œè®Šæˆæ›´å¥½æŸ¥é©—èˆ‡ç®¡ç†çš„æ†‘è­‰ã€‚",
        "å®ƒä¸æ˜¯è¦ä½ è¡å‹•æŠ•è³‡ï¼Œè€Œæ˜¯è®“æµç¨‹æ›´æ¸…æ¥šã€å¯è¿½è¹¤ã€‚",
        "å®‰å…¨åŸå‰‡ï¼šé‡åˆ°è¦ä½ ã€å…ˆä»˜è²»/å…ˆç°½åã€çš„é™Œç”Ÿé€£çµï¼Œä¸€æ¨£å…ˆåœä¸‹ä¾†æŸ¥ä¾†æºã€‚"
      ].join("\n"),
      quiz:{
        q:"å“ªå€‹æ¯”è¼ƒåƒ RWAï¼Ÿ",
        a:[
          {t:"å¯é©—è­‰çš„é›»å­é–€ç¥¨æ†‘è­‰", ok:true},
          {t:"é™Œç”Ÿäººç™¼çš„é™æ™‚å¿«é ˜é€£çµ", ok:false}
        ]
      }
    },
  ];

  const dramaLines = [
    { who:"koko", text:"ç¾ç¾ï¼Œæˆ‘çœ‹åˆ°ä¸€å€‹ã€é™æ™‚å¿«é ˜ã€é€£çµï¼Œé»é€²å»è·³å‡ºéŒ¢åŒ…è¦–çª—ã€‚" },
    { who:"meimei", text:"å…ˆåœã€‚å®ƒè¦ä½ åŒæ„ä»€éº¼ï¼Ÿæœ‰æ²’æœ‰å¯«ç„¡é™é¡ï¼Ÿ" },
    { who:"koko", text:"æœ‰è€¶ï¼Œå¯«ç„¡é™é¡æˆæ¬Šï¼Œé‚„èªªæ¯”è¼ƒæ–¹ä¾¿ã€‚" },
    { who:"meimei", text:"é‚£å°±å…ˆæ‹’çµ•ã€‚å…ˆé—œæ‰ã€å»å®˜æ–¹ç¢ºèªå†èªªã€‚" },
    { who:"koko", text:"å¥½ï¼æˆ‘æ‡‚äº†ï¼šçœ‹ä¸æ‡‚å°±å…ˆä¸è¦ç°½ã€‚" }
  ];

  bodyHTML(`
    <div class="mt-2 p-4 rounded-2xl blkA">
      <div class="flex items-center justify-between gap-2">
        <div class="font-extrabold text-slate-900">å€å¡Š Aï½œä¸‰å¼µçŸ¥è­˜å¡ï¼ˆæ¯å¼µç­”ä¸€é¡Œç¢ºèªç†è§£ï¼‰</div>
        <div class="text-xs font-black text-slate-700 bg-white/70 border border-white/80 px-3 py-2 rounded-xl">
          å·²å®Œæˆï¼š<span id="cardOK">0</span>/3
        </div>
      </div>

      <div class="mt-3 space-y-3" id="cardsWrap">
        ${cards.map((c, i)=>`
          <div id="s1Card${i}" class="p-4 rounded-2xl teach-card card-hover">
            <div class="teach-inner">
              <div class="flex items-center gap-2">
                <!-- âœ…ï¼ˆv8è®Šæ›´#1ï¼‰èªéŸ³åœ–ç¤ºç§»åˆ° ğŸ‘›ğŸ§¾ğŸ  å·¦å´ï¼ˆå–ä»£å³ä¸Šè§’ï¼‰ï¼Œé è¨­é–‹ -->
                <button type="button" class="voice-mini s1VoiceMini" title="èªéŸ³é–‹é—œï¼ˆé è¨­é–‹ï¼‰">ğŸ”Š</button>

                <div class="w-10 h-10 rounded-2xl bg-emerald-50 border border-emerald-100 flex items-center justify-center text-lg">${c.icon}</div>
                <div class="font-extrabold text-slate-900">${c.title}</div>
                <div id="doneDot${i}" class="ml-auto hidden text-sm font-black text-emerald-700">âœ… å·²æ‡‚</div>
              </div>

              <div class="text-sm text-slate-800 mt-3 leading-relaxed">
                <span class="font-extrabold text-slate-900">ä¸€å¥è©±ï¼š</span>${c.core}
              </div>

              <div class="mt-3 flex justify-center">
                <button id="more${i}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-slate-800 font-extrabold hover:bg-slate-50 shadow-soft text-sm">
                  é»æˆ‘æ›´äº†è§£
                </button>
              </div>

              <div class="mt-4 p-3 rounded-2xl bg-white border border-slate-200">
                <div class="text-sm font-extrabold text-slate-900">${c.quiz.q}</div>
                <div class="mt-2 grid gap-2">
                  ${c.quiz.a.map((a, j)=>`
                    <button data-ci="${i}" data-ai="${j}"
                      class="w-full text-left p-3 rounded-2xl border border-slate-200 bg-slate-50 hover:bg-white font-semibold text-slate-800">
                      ${a.t}
                    </button>
                  `).join("")}
                </div>
                <div id="quizMsg${i}" class="mt-3 hidden p-3 rounded-2xl border text-sm"></div>
              </div>
            </div>
          </div>
        `).join("")}
      </div>
    </div>

    <div class="mt-4 p-4 rounded-2xl blkB">
      <div class="flex items-center justify-between gap-2">
        <div class="font-extrabold text-slate-900">å€å¡Š Bï½œå°åŠ‡å ´</div>

        <!-- âœ…ï¼ˆv8è®Šæ›´#2ï¼‰æ”¹ç‚ºã€Œé–‹å§‹/ç¹¼çºŒã€ï¼‹ã€Œæš«åœã€ä¸¦åœ¨ä¸‹æ–¹è¨»è¨˜åç¨±èˆ‡ç”¨é€” -->
        <div class="flex items-start gap-2">
          <div class="flex flex-col items-center">
            <button id="dramaStart"
              class="w-12 h-12 rounded-2xl bg-blue-600 border-2 border-white text-white font-black hover:bg-blue-700 text-xl shadow-soft flex items-center justify-center"
              title="é–‹å§‹ / ç¹¼çºŒ">â–¶ï¸</button>
            <div class="mt-1 text-[11px] font-black text-slate-700">é–‹å§‹/ç¹¼çºŒ</div>
          </div>

          <div class="flex flex-col items-center">
            <button id="dramaPause"
              class="w-12 h-12 rounded-2xl bg-amber-500 border-2 border-white text-white font-black hover:bg-amber-600 text-xl shadow-soft flex items-center justify-center"
              title="æš«åœ">â¸ï¸</button>
            <div class="mt-1 text-[11px] font-black text-slate-700">æš«åœ</div>
          </div>
        </div>
      </div>

     
      <div class="mt-3 p-4 rounded-2xl drama-stage">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div id="actorMei" class="p-4 rounded-2xl actor-card">
            <div class="flex items-center gap-3">
              <div class="w-14 h-14 rounded-2xl bg-rose-50 border border-rose-100 flex items-center justify-center overflow-hidden">
                <svg viewBox="0 0 120 120" class="w-full h-full">
                  <circle cx="60" cy="44" r="22" fill="#F7D7C4"/>
                  <path suggests="M38 40c6-18 38-18 44 0" fill="#5B4B3A"/>
                  <circle cx="52" cy="46" r="3.2" fill="#111827"/>
                  <circle cx="68" cy="46" r="3.2" fill="#111827"/>
                  <g class="mouth" id="meiMouth">
                    <ellipse cx="60" cy="56" rx="7" ry="3.6" fill="#111827"/>
                    <ellipse cx="60" cy="56.3" rx="6.2" ry="2.8" fill="#FB7185" opacity="0.55"/>
                  </g>
                  <path d="M40 74c6-10 34-10 40 0v26H40z" fill="#10B981"/>
                </svg>
              </div>
              <div class="font-extrabold text-slate-900 text-lg">ç¾ç¾</div>
            </div>
            <div id="meiBubble" class="mt-3 p-3 rounded-2xl bubble text-sm text-slate-700 leading-relaxed min-h-[74px]">(ç­‰å¾…é–‹å§‹)</div>
          </div>

          <div id="actorKo" class="p-4 rounded-2xl actor-card">
            <div class="flex items-center gap-3">
              <div class="w-14 h-14 rounded-2xl bg-sky-50 border border-sky-100 flex items-center justify-center overflow-hidden">
                <svg viewBox="0 0 120 120" class="w-full h-full">
                  <circle cx="60" cy="44" r="22" fill="#F7D7C4"/>
                  <path d="M36 40c8-20 40-18 48 0" fill="#2F3B4A"/>
                  <circle cx="52" cy="46" r="3.2" fill="#111827"/>
                  <circle cx="68" cy="46" r="3.2" fill="#111827"/>
                  <g class="mouth" id="koMouth">
                    <ellipse cx="60" cy="56" rx="7" ry="3.6" fill="#111827"/>
                    <ellipse cx="60" cy="56.3" rx="6.2" ry="2.8" fill="#60A5FA" opacity="0.45"/>
                  </g>
                  <path d="M40 74c6-10 34-10 40 0v26H40z" fill="#0EA5E9"/>
                </svg>
              </div>
              <div class="font-extrabold text-slate-900 text-lg">å¯å¯</div>
            </div>
            <div id="koBubble" class="mt-3 p-3 rounded-2xl bubble text-sm text-slate-700 leading-relaxed min-h-[74px]">(ç­‰å¾…é–‹å§‹)</div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 p-4 rounded-2xl blkC">
      <div class="font-extrabold text-slate-900">å€å¡Š Cï½œæƒ…å¢ƒé¸æ“‡</div>

      <div class="mt-3 p-4 rounded-2xl bg-white border border-amber-100">
        <div class="text-sm font-extrabold text-slate-900">æƒ…å¢ƒ</div>
        <div class="text-sm text-slate-700 mt-2 leading-relaxed">
          ä½ è¦é ˜çå‹µï¼Œé»é€²é™Œç”Ÿé€£çµå¾Œè·³å‡ºéŒ¢åŒ…è¦–çª—ï¼Œé‚„å¯«ã€Œç„¡é™é¡æˆæ¬Šã€ã€‚
        </div>

        <div class="mt-4 grid gap-3">
          <button id="s1op0" class="w-full text-left p-4 rounded-2xl choice-btn font-semibold text-slate-800">
            å…ˆåŒæ„ï¼Œåæ­£åªæ˜¯é ˜çå‹µ
          </button>
          <button id="s1op1" class="w-full text-left p-4 rounded-2xl choice-btn choice-strong font-semibold text-slate-900">
            å…ˆæ‹’çµ•ï¼Œé—œæ‰é€£çµï¼Œå»å®˜æ–¹ç¢ºèªå†æ“ä½œ
          </button>
        </div>

        <div id="s1feedback" class="mt-4 hidden p-4 rounded-2xl border"></div>
      </div>

      <div class="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
        <button id="btnGo2" class="w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
          å°šæœªè§£é–
        </button>
      </div>
    </div>

    <div id="s1InnerModal" class="fixed inset-0 hidden items-center justify-center p-6 inner-modal">
      <!-- âœ…ï¼ˆv8è®Šæ›´#3ï¼‰é»ç©ºç™½è™•å¯é—œé–‰ -->
      <div class="absolute inset-0 inner-modal-backdrop"></div>
      <div class="relative w-full max-w-lg rounded-3xl bg-white border border-slate-200 shadow-soft p-5 pop-overlay">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="s1InnerTitle" class="text-lg font-black text-slate-900">æ›´è©³ç´°èªªæ˜</div>
            <div class="text-sm text-slate-600 mt-1">ï¼ˆå¯é¸çœ‹ï¼‰</div>
          </div>
          <button id="s1InnerClose" class="w-10 h-10 rounded-2xl bg-slate-900 text-white font-black hover:bg-slate-800">âœ•</button>
        </div>

        <div id="s1InnerText" class="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-100 text-slate-800 text-sm leading-relaxed whitespace-pre-line"></div>

        <button id="s1InnerOk" class="mt-4 w-full px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-slate-800">
          æˆ‘çœ‹æ‡‚äº†ï¼ˆé—œé–‰ï¼‰
        </button>
      </div>
    </div>
  `);

  let cardDone = [false,false,false];
  let dramaDone = false;
  let scenarioPassed = false;

  /* âœ…ï¼ˆv8#1ï¼‰ä¸‰å€‹èªéŸ³æŒ‰éˆ•åŒæ­¥æ§åˆ¶åŒä¸€å€‹ SOUND_ON */
  function renderVoiceMinis(){
    document.querySelectorAll(".s1VoiceMini").forEach(btn=>{
      btn.textContent = SOUND_ON ? "ğŸ”Š" : "ğŸ”‡";
      btn.setAttribute("aria-pressed", SOUND_ON ? "true" : "false");
    });
  }
  function toggleVoice(){
    ensureAudio();
    SOUND_ON = !SOUND_ON;
    if(!SOUND_ON){
      stopTTS();
      if("speechSynthesis" in window){ try{ window.speechSynthesis.pause(); }catch(e){} }
    }else{
      if("speechSynthesis" in window){ try{ window.speechSynthesis.resume(); }catch(e){} }
    }
    renderVoiceMinis();
  }
  document.querySelectorAll(".s1VoiceMini").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      toggleVoice();
    });
  });
  renderVoiceMinis();

  function updateS1(){
    setText("cardOK", String(cardDone.filter(Boolean).length));
    if(cardDone.every(Boolean) && dramaDone && scenarioPassed){
      const btn = $("btnGo2");
      btn.disabled = false;
      btn.className = "w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700";
      btn.textContent = "é ˜å–çå‹µä¸¦å‰å¾€ç¬¬ 2 é—œï¼ˆ+80ï¼‰";
      btn.onclick = ()=>{
        addEco(80, "level1_reward");
        markCompleted(1);
        closeModal();
        jumpTo(2, 1);
      };
    }
  }

  function openInner(i){
    $("s1InnerTitle").textContent = cards[i].title + "ï½œæ›´è©³ç´°èªªæ˜";
    $("s1InnerText").textContent = cards[i].detail;
    show($("s1InnerModal"));
    if(SOUND_ON){
      speakOnce(cards[i].core, { rate: 1.02, pitch: 1.02 });
    }
  }
  function closeInner(){
    hide($("s1InnerModal"));
    stopTTS();
  }
  $("s1InnerClose").onclick = closeInner;
  $("s1InnerOk").onclick = closeInner;

  /* âœ…ï¼ˆv8#3ï¼‰é»ç©ºç™½è™•å³å¯é—œé–‰ inner modal */
  $("s1InnerModal").addEventListener("click", (e)=>{
    if(e.target === $("s1InnerModal") || e.target.classList.contains("inner-modal-backdrop")){
      closeInner();
    }
  });

  cards.forEach((_, i)=>{
    const cardEl = $("s1Card"+i);
    const moreBtn = $("more"+i);

    cardEl.addEventListener("mouseenter", ()=>{
      if(!SOUND_ON) return;
      speakOnce(cards[i].core, { rate: 1.02, pitch: 1.02 });
    });
    cardEl.addEventListener("mouseleave", ()=>{ stopTTS(); });

    moreBtn.addEventListener("focus", ()=>{
      if(!SOUND_ON) return;
      speakOnce(cards[i].core, { rate: 1.02, pitch: 1.02 });
    });
    moreBtn.addEventListener("blur", ()=>{ stopTTS(); });

    moreBtn.addEventListener("click", ()=>{
      stopTTS();
      openInner(i);
    });
  });

  const cardsWrap = $("cardsWrap");
  cardsWrap.addEventListener("click", (ev)=>{
    const btn = ev.target.closest("button[data-ci]");
    if(!btn) return;
    const ci = Number(btn.dataset.ci);
    const ai = Number(btn.dataset.ai);
    if(cardDone[ci]) return;

    const opt = cards[ci].quiz.a[ai];
    const msg = $("quizMsg"+ci);
    msg.classList.remove("hidden");

    if(opt.ok){
      cardDone[ci] = true;
      $("doneDot"+ci).classList.remove("hidden");
      msg.className = "mt-3 p-3 rounded-2xl border text-sm bg-emerald-50 border-emerald-100 text-emerald-800";
      msg.innerHTML = `<b>âœ… æ­£ç¢ºï¼</b> ä½ å·²ç†è§£é€™å¼µå¡çš„é‡é»ã€‚`;
      sfxGood();
      updateS1();
    }else{
      msg.className = "mt-3 p-3 rounded-2xl border text-sm bg-sky-50 border-sky-100 text-sky-800";
      msg.innerHTML = `<b>å†æƒ³ä¸€ä¸‹</b>ï¼šä½ å¯ä»¥é»ã€Œé»æˆ‘æ›´äº†è§£ã€çœ‹æ›´è©³ç´°èªªæ˜ã€‚`;
      sfxEncourage();
    }
  });

  const actorMei = $("actorMei");
  const actorKo  = $("actorKo");
  const meiBubble = $("meiBubble");
  const koBubble  = $("koBubble");
  function setTalking(who, on){
    if(who === "meimei") actorMei.classList.toggle("talking", on);
    else actorKo.classList.toggle("talking", on);
  }

  /* âœ…ï¼ˆv8#2ï¼‰å°åŠ‡å ´ï¼šé–‹å§‹/ç¹¼çºŒï¼‹æš«åœï¼›æ¯å¥è¬›å®Œæ‰æ›ä¸‹ä¸€å¥ï¼ˆç¶­æŒåŸè¦å‰‡ï¼‰ */
  let dramaIdx = 0;
  let dramaPlaying = false;
  let dramaPaused = false;
  let dramaTimer = null;
  let dramaNextTimer = null;
  let lineInProgress = false;
  let currentWho = null;

  function dramaResetUI(){
    meiBubble.textContent = "(ç­‰å¾…é–‹å§‹)";
    koBubble.textContent = "(ç­‰å¾…é–‹å§‹)";
    setTalking("meimei", false);
    setTalking("koko", false);
  }
  function dramaHardStop(){
    dramaPlaying = false;
    dramaPaused = false;
    lineInProgress = false;
    currentWho = null;
    if(dramaTimer){ clearTimeout(dramaTimer); dramaTimer = null; }
    if(dramaNextTimer){ clearTimeout(dramaNextTimer); dramaNextTimer = null; }
    stopTTS();
    try{
      if("speechSynthesis" in window){
        window.speechSynthesis.cancel();
      }
    }catch(e){}
    setTalking("meimei", false);
    setTalking("koko", false);
  }

  function speakDramaLine(line, onDone){
    if(!SOUND_ON) { onDone && onDone(); return; }
    stopTTS();
    lineInProgress = true;
    currentWho = line.who;

    const isMei = line.who === "meimei";
    /* âœ…ï¼ˆv8#2ï¼‰é¿å…ã€Œè½ä¸åˆ°ã€ï¼šæŠŠå¯å¯çš„ pitch èª¿å›æ­£å¸¸å¯è½ç¯„åœï¼ˆä¸æ”¹å°è©å…§å®¹ï¼‰ */
    const pitch = isMei ? 1.15 : 0.95;
    const rate  = 1.02;

    setTalking("meimei", isMei);
    setTalking("koko", !isMei);

    if(isMei){
      meiBubble.textContent = line.text;
      koBubble.textContent = "";
    }else{
      koBubble.textContent = line.text;
      meiBubble.textContent = "";
    }

    const u = speakOnce(line.text, { pitch, rate });
    if(!u) {
      lineInProgress = false;
      setTalking("meimei", false);
      setTalking("koko", false);
      onDone && onDone();
      return;
    }
    u.onend = ()=>{
      lineInProgress = false;
      setTalking("meimei", false);
      setTalking("koko", false);
      onDone && onDone();
    };
    u.onerror = ()=>{
      lineInProgress = false;
      setTalking("meimei", false);
      setTalking("koko", false);
      onDone && onDone();
    };
  }

  function dramaNext(){
    if(!dramaPlaying || dramaPaused) return;

    if(dramaIdx >= dramaLines.length){
      dramaPlaying = false;
      dramaDone = true;
      updateS1();
      return;
    }
    const line = dramaLines[dramaIdx];

    speakDramaLine(line, ()=>{
      if(!dramaPlaying || dramaPaused) return;
      dramaIdx++;
      if(dramaNextTimer) clearTimeout(dramaNextTimer);
      dramaNextTimer = setTimeout(()=> dramaNext(), 160);
    });
  }

  function dramaStartOrResume(){
    // å¦‚æœæ˜¯æš«åœç‹€æ…‹ â†’ ç¹¼çºŒ
    if(dramaPaused){
      dramaPaused = false;

      // è‹¥æ˜¯ TTS æš«åœä¸­ï¼Œæ¢å¾©
      try{
        if("speechSynthesis" in window && window.speechSynthesis.paused){
          window.speechSynthesis.resume();
          if(currentWho){ setTalking("meimei", currentWho==="meimei"); setTalking("koko", currentWho==="koko"); }
        }
      }catch(e){}

      // è‹¥å‰›å¥½åœ¨å…©å¥ä¹‹é–“ï¼ˆæ²’æœ‰æ­£åœ¨è¬›ï¼‰ï¼Œå°±ç¹¼çºŒä¸‹ä¸€å¥
      if(!lineInProgress){
        dramaNext();
      }
      return;
    }

    // ä¸æ˜¯æš«åœ â†’ å¾é ­é–‹å§‹æ’­æ”¾
    dramaHardStop();
    dramaPlaying = true;
    dramaPaused = false;
    dramaIdx = 0;
    dramaResetUI();

    if(!SOUND_ON){
      // ç„¡è²æ¨¡å¼ï¼šç”¨æ–‡å­—ç¯€å¥æ¨¡æ“¬ï¼ˆæ¯å¥çµæŸæ‰æ›ä¸‹ä¸€å¥ï¼‰
      const stepText = ()=>{
        if(!dramaPlaying || dramaPaused) return;
        if(dramaIdx >= dramaLines.length){
          dramaPlaying = false;
          dramaDone = true;
          updateS1();
          return;
        }
        const line = dramaLines[dramaIdx];
        if(line.who === "meimei"){ meiBubble.textContent = line.text; koBubble.textContent = ""; }
        else { koBubble.textContent = line.text; meiBubble.textContent = ""; }
        dramaIdx++;
        dramaTimer = setTimeout(stepText, 900);
      };
      stepText();
      return;
    }

    dramaNext();
  }

  function dramaPause(){
    if(!dramaPlaying) return;
    dramaPaused = true;

    // åœæ­¢ä¸‹ä¸€å¥æ’ç¨‹
    if(dramaTimer){ clearTimeout(dramaTimer); dramaTimer = null; }
    if(dramaNextTimer){ clearTimeout(dramaNextTimer); dramaNextTimer = null; }

    // æš«åœèªéŸ³ï¼ˆä¸å–æ¶ˆï¼Œæ‰èƒ½ç¹¼çºŒï¼‰
    try{
      if("speechSynthesis" in window){
        window.speechSynthesis.pause();
      }
    }catch(e){}

    // åœæ­¢å˜´å·´å‹•ç•«
    setTalking("meimei", false);
    setTalking("koko", false);
  }

  $("dramaStart").onclick = ()=>{ ensureAudio(); dramaStartOrResume(); };
  $("dramaPause").onclick = ()=>{ dramaPause(); };

  const feedback = $("s1feedback");
  function showFeedback(ok, title, msg){
    feedback.classList.remove("hidden");
    feedback.className = "mt-4 p-4 rounded-2xl border " + (ok ? "bg-emerald-50 border-emerald-100" : "bg-sky-50 border-sky-100");
    feedback.innerHTML = `
      <div class="font-extrabold text-slate-900 text-lg">${title}</div>
      <div class="text-base text-slate-700 mt-2 leading-relaxed">${msg}</div>
    `;
  }
  $("s1op0").onclick = ()=>{
    showFeedback(false, "å†è©¦ä¸€æ¬¡", "çœ‹åˆ°ç„¡é™é¡æˆæ¬Šï¼Œå…ˆä¸è¦åŒæ„ã€‚å…ˆé—œæ‰ã€æŸ¥ä¾†æºï¼Œå†æ±ºå®šã€‚");
    sfxEncourage();
    scenarioPassed = false;
    updateS1();
  };
  $("s1op1").onclick = ()=>{
    showFeedback(true, "åšå¾—å¥½ï¼", "ä½ å…ˆæ‹’çµ•ä¸¦ç¢ºèªä¾†æºï¼Œæ˜¯æœ€å®‰å…¨çš„åšæ³•ã€‚");
    sfxLevelUp();
    scenarioPassed = true;
    updateS1();
  };

  updateS1();
}

/* =========================
   Stage2
========================= */
function stage2(){
  openModal("ç¬¬ 2 é—œï½œNFT è¾¨è­˜ç¿»ç‰Œ", "æŒ‰ã€Œç™¼ç‰Œã€â†’ å¡ç‰‡ä¸€å¼µä¸€å¼µå‡ºç¾ã€‚æ‰¾å‡ºå¯é©—è­‰ä¾†æºé‚£å¼µï¼ˆ+60ï¼‰");

  bodyHTML(`
    <div class="p-4 rounded-2xl bg-sky-50 border border-sky-100">
      <div class="font-extrabold text-slate-900">ç©æ³•</div>
      <div class="mt-2 text-sm text-slate-700 leading-relaxed">
        æŒ‰ä¸€æ¬¡ã€Œç™¼ç‰Œã€ï¼Œæœƒä¸€å¼µä¸€å¼µæŠŠ 6 å¼µå¡ç™¼å‡ºä¾†ã€‚ä½ æœ‰ <b>3 æ¬¡</b>ç¿»ç‰Œæ©Ÿæœƒï¼Œæ‰¾å‡ºã€Œå¯é©—è­‰ä¾†æºç‰Œã€å°±éé—œã€‚
      </div>

      <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
        <button id="btnDeal2" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700 text-sm">
          ğŸ«³ ç™¼ç‰Œ
        </button>
        <div class="text-sm text-slate-700 font-bold">
          å‰©é¤˜å˜—è©¦ï¼š<span id="tries2">3</span>
        </div>
      </div>
    </div>

    <div id="gridWrap2" class="mt-4 hidden">
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-3" id="grid2"></div>
      <div class="mt-3 p-4 rounded-2xl bg-white border border-slate-200">
        <div class="font-extrabold text-slate-900">çµæœ</div>
        <div id="msg2" class="text-sm text-slate-700 mt-1">è«‹å…ˆç™¼ç‰Œã€‚</div>
      </div>
    </div>
  `);

  let tries = 3;
  let playing = false;

  const triesEl = $("tries2");
  const gridWrap = $("gridWrap2");
  const grid = $("grid2");
  const msg = $("msg2");

  function setTries(n){ tries = n; triesEl.textContent = String(n); }

  const deckTypes = [
    { title:"é™æ™‚å¿«é ˜ç‰Œ", hint:"ç”¨é™æ™‚è£½é€ æ€¥è¿«", isReal:false },
    { title:"å…ˆä»˜æ‰‹çºŒè²»ç‰Œ", hint:"è¦ä½ å…ˆä»˜å°é¡è²»ç”¨", isReal:false },
    { title:"åªæœ‰åœ–ç‰‡ç‰Œ", hint:"åªæœ‰åœ–ç‰‡ï¼Œæ²’æœ‰ä¾†æº", isReal:false },
    { title:"ç¸®ç¶²å€ç‰Œ", hint:"ç¸®ç¶²å€/é™Œç”Ÿç¶²å€", isReal:false },
    { title:"å…ˆç°½æ‰çµ¦çœ‹ç‰Œ", hint:"è¦å…ˆç°½å/å…ˆæˆæ¬Š", isReal:false },
    { title:"å¯é©—è­‰ä¾†æºç‰Œ", hint:"å®˜æ–¹ä¾†æº/åˆç´„å¯é©—è­‰", isReal:true },
  ];

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function buildCard(i, cardDef){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "p-4 rounded-2xl bg-white border border-slate-200 text-left card-hover deal-enter";
    btn.dataset.revealed = "0";

    btn.innerHTML = `
      <div class="text-xs font-bold text-slate-500">Card #${i+1}</div>
      <div class="mt-2">
        <div class="w-10 h-10 rounded-2xl bg-pink-50 border border-pink-100 flex items-center justify-center">
          <span class="text-xl">ğŸ§¾</span>
        </div>
      </div>

      <div class="mt-2 font-extrabold text-slate-900 text-lg">${cardDef.title}</div>

      <div class="mt-1 text-sm text-slate-700 leading-relaxed">
        ï¼ˆæœªç¿»ç‰Œï¼‰æç¤ºï¼š${cardDef.hint}
      </div>

      <div class="mt-3 w-full px-3 py-3 rounded-2xl bg-slate-50 border border-slate-200 text-slate-800 font-extrabold text-center">
        é»æ“Šã€Œç¿»ç‰Œã€ç¢ºèªé€™å¼µæ˜¯ä¸æ˜¯ä¾†æºå¯é©—è­‰
      </div>
    `;

    btn.addEventListener("click", ()=>{
      if(!playing) return;
      if(tries <= 0) return;
      if(btn.dataset.revealed === "1") return;

      btn.dataset.revealed = "1";
      btn.disabled = true;
      sfxFlip();

      if(cardDef.isReal){
        playing = false;

        btn.innerHTML = `
          <div class="text-xs font-bold text-emerald-700">é©—è­‰é€šé</div>
          <div class="mt-2">
            <div class="w-10 h-10 rounded-2xl bg-emerald-50 border border-emerald-100 flex items-center justify-center">
              <span class="text-xl">ğŸ¥¤</span>
            </div>
          </div>
          <div class="mt-2 font-extrabold text-slate-900 text-lg">${cardDef.title}</div>
          <div class="mt-1 text-sm text-slate-700 leading-relaxed">
            âœ… ä½ ç¿»åˆ°ã€Œå®˜æ–¹ä¾†æº/åˆç´„å¯é©—è­‰ã€çš„é‚£å¼µï¼
          </div>
          <div class="mt-2 text-xs text-emerald-700 font-bold bg-emerald-50 border border-emerald-100 rounded-xl px-2 py-2">
            é‡é»ï¼šçœŸæ­£è¦çœ‹çš„æ˜¯ã€Œä¾†æº/åˆç´„ã€èƒ½ä¸èƒ½é©—è­‰
          </div>
        `;

        msg.innerHTML = `<span class="font-black text-emerald-700">æˆåŠŸï¼</span>ä½ æ‰¾åˆ°å¯é©—è­‰ä¾†æºç‰Œï¼ˆ+60ï¼‰ã€‚`;
        addEco(60, "level2_nft_win");
        markCompleted(2);
        setTries(0);

        setTimeout(()=>{
          closeModal();
          jumpTo(3, 2);
        }, 450);

      }else{
        btn.innerHTML = `
          <div class="text-xs font-bold text-rose-700">ä¾†æºä¸æ˜</div>
          <div class="mt-2">
            <div class="w-10 h-10 rounded-2xl bg-rose-50 border border-rose-100 flex items-center justify-center">
              <span class="text-xl">ğŸ–¼ï¸</span>
            </div>
          </div>
          <div class="mt-2 font-extrabold text-slate-900 text-lg">${cardDef.title}</div>
          <div class="mt-1 text-sm text-slate-700 leading-relaxed">
            âš ï¸ é€™å¼µæ˜¯é‡£é­šç‰¹å¾µï¼š${cardDef.hint}
          </div>
          <div class="mt-2 text-xs text-sky-700 font-bold bg-sky-50 border border-sky-100 rounded-xl px-2 py-2">
            æç¤ºï¼šè¦æ‰¾ã€Œå¯é©—è­‰ä¾†æºç‰Œã€
          </div>
        `;

        setTries(tries - 1);
        sfxBad();

        msg.innerHTML = tries > 0
          ? `<span class="font-black text-rose-700">ä¸æ˜¯å¯é©—è­‰ä¾†æºã€‚</span>å†æ‰¾ä¸€æ¬¡ï¼ˆå‰© ${tries} æ¬¡ï¼‰ã€‚`
          : `<span class="font-black text-slate-900">æ©Ÿæœƒç”¨å®Œã€‚</span>å†æŒ‰ã€Œç™¼ç‰Œã€é‡æ–°é–‹å§‹ã€‚`;

        if(tries <= 0) playing = false;
      }
    });

    return btn;
  }

  function resetGrid(){
    const shuffled = shuffle(deckTypes);
    const cards = [];
    for(let i=0;i<6;i++){
      cards.push(buildCard(i, shuffled[i]));
    }
    return cards;
  }

  $("btnDeal2").onclick = ()=>{
    show(gridWrap);
    setTries(3);
    playing = true;
    msg.textContent = "å¡ç‰‡æœƒä¸€å¼µä¸€å¼µå‡ºç¾ï¼Œæ‰¾å‡ºã€Œå¯é©—è­‰ä¾†æºç‰Œã€ã€‚";

    const cards = resetGrid();
    grid.innerHTML = "";
    let idx = 0;
    const dealNext = ()=>{
      if(idx >= cards.length) return;
      sfxFlip();
      grid.appendChild(cards[idx]);
      idx++;
      setTimeout(dealNext, 220);
    };
    dealNext();
  };
}

/* =========================
   Stage3ï¼ˆåš´æ ¼éµå®ˆï¼šä¸æ”¹ï¼‰
========================= */
function stage3(){
  openModal("ç¬¬ 3 é—œï½œåè©ç´…æ——åˆ†é¡ï¼ˆéŠæˆ²ï¼‰", "æŠŠå¡ç‰‡åˆ†é¡åˆ°ã€Œå®‰å…¨ / å¯ç–‘ã€ã€‚å…¨éƒ¨åˆ†é¡å®Œæˆå³å¯éé—œï¼ˆ+80ï¼‰ã€‚");

  const cards = [
    { title: "å®˜æ–¹æ´»å‹•é é¢ï¼ˆå¯åœ¨å®˜æ–¹ç¤¾ç¾¤æ‰¾åˆ°åŒæ¨£å…¬å‘Šï¼‰", correct: "safe", why: "âœ… èƒ½åœ¨å®˜æ–¹ç¤¾ç¾¤/å®˜ç¶²æ‰¾åˆ°åŒæ¨£å…¬å‘Šï¼Œä¾†æºä¸€è‡´ï¼Œé¢¨éšªè¼ƒä½ã€‚" },
    { title: "ç¸®ç¶²å€é€£çµï¼Œè¦æ±‚ä½ ç«‹åˆ»ç°½åæ‰èƒ½é ˜", correct: "sus",  why: "âš ï¸ ç¸®ç¶²å€çœ‹ä¸åˆ°çœŸæ­£ç¶²åŸŸï¼‹è¦ä½ ç«‹åˆ»ç°½åï¼Œæ˜¯å¸¸è¦‹é‡£é­šå¥—è·¯ã€‚" },
    { title: "æˆæ¬Šå…§å®¹æ¸…æ¥šã€ä¸”åªéœ€è¦é™é¡ï¼ˆéç„¡é™é¡ï¼‰", correct: "safe", why: "âœ… æˆæ¬Šç¯„åœæ¸…æ¥šä¸”æœ‰é™é¡ï¼Œé¢¨éšªæ˜é¡¯æ¯”ç„¡é™é¡ä½ã€‚" },
    { title: "è·³å‡ºè¦–çª—å¯«ã€ŒApprove unlimited spendï¼ˆç„¡é™é¡ï¼‰ã€", correct: "sus",  why: "âš ï¸ ç„¡é™é¡æˆæ¬Šé¢¨éšªæœ€é«˜ï¼Œå¯èƒ½è¢«ç›´æ¥æ‹¿èµ°è³‡ç”¢æ“ä½œæ¬Šé™ã€‚" },
    { title: "è¦ä½ å…ˆä»˜å°é¡æ‰‹çºŒè²»æ‰çµ¦ä½ çœ‹çå‹µ/é ˜ç©ºæŠ•", correct: "sus",  why: "âš ï¸ å…ˆæ”¶å°é¡è²»ç”¨å¸¸æ˜¯è©é¨™é–‹é ­ï¼Œå®¹æ˜“è¶Šé™·è¶Šæ·±ã€‚" },
    { title: "ç¶²å€èˆ‡ä½ å¹³å¸¸ä½¿ç”¨çš„å®˜æ–¹ç¶²åŸŸä¸€è‡´ï¼ˆç„¡å¥‡æ€ªæ‹¼å­—ï¼‰", correct: "safe", why: "âœ… ç¶²åŸŸä¸€è‡´ä¸”ç„¡æ€ªæ‹¼å­—ï¼Œç›¸å°å®‰å…¨ï¼ˆä»å»ºè­°å†å°ç…§å®˜æ–¹å…¬å‘Šï¼‰ã€‚" },
  ];

  bodyHTML(`
    <div class="p-4 rounded-2xl bg-amber-50 border border-amber-100">
      <div class="font-extrabold text-slate-900">ä»»å‹™</div>
      <div class="text-sm text-slate-700 mt-2">æŠŠæ¯å¼µå¡åˆ†é¡åˆ°ã€Œå®‰å…¨ / å¯ç–‘ã€ã€‚åˆ†é¡å®Œæœƒç«‹å³å‘Šè¨´ä½ å°ä¸å°ã€‚</div>
    </div>

    <div class="mt-4 space-y-3" id="s3List"></div>

    <div class="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
      <button id="btnFinish3" class="w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
        å°šæœªå®Œæˆ
      </button>
    </div>

    <div class="mt-3 flex justify-end">
      <button id="s3Reset" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-slate-700 font-extrabold hover:bg-white">
        é‡ä¾†
      </button>
    </div>
  `);

  const list = $("s3List");
  let done = Array(cards.length).fill(false);

  function badgeHTML(status){
    if(status === "done"){
      return `<span class="text-xs font-bold px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">âœ… å·²å®Œæˆ</span>`;
    }
    return `<span class="text-xs font-bold px-3 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200">å°šæœªåˆ†é¡</span>`;
  }

  function render(){
    list.innerHTML = "";
    cards.forEach((c, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "p-4 rounded-2xl bg-white border border-slate-200";
      wrap.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="font-extrabold text-slate-900">${c.title}</div>
          <div id="s3Badge${idx}">${badgeHTML(done[idx] ? "done" : "new")}</div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3">
          <button data-idx="${idx}" data-pick="safe"
            class="w-full py-4 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700 flex items-center justify-center gap-2">
            <span class="text-lg">âœ…</span><span class="text-lg">å®‰å…¨</span>
          </button>
          <button data-idx="${idx}" data-pick="sus"
            class="w-full py-4 rounded-2xl bg-rose-600 text-white font-extrabold hover:bg-rose-700 flex items-center justify-center gap-2">
            <span class="text-lg">âš ï¸</span><span class="text-lg">å¯ç–‘</span>
          </button>
        </div>

        <div id="s3Hint${idx}" class="mt-3 hidden p-4 rounded-2xl border text-sm"></div>
      `;
      list.appendChild(wrap);

      if(done[idx]){
        wrap.querySelectorAll("button[data-idx]").forEach(b=>{
          b.disabled = true;
          b.className += " opacity-70 cursor-not-allowed";
        });
      }
    });

    if(done.every(Boolean)){
      const fin = $("btnFinish3");
      fin.disabled = false;
      fin.className = "w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700";
      fin.textContent = "é€šé—œï¼ˆé ˜å– +80ï¼‰â†’ å‰å¾€ç¬¬ 4 é—œ";
      fin.onclick = ()=>{
        addEco(80, "level3_reward");
        markCompleted(3);
        closeModal();
        jumpTo(4, 3);
      };
    }
  }

  function showHint(idx, ok, text){
    const box = $("s3Hint"+idx);
    box.classList.remove("hidden");
    box.className = "mt-3 p-4 rounded-2xl border text-sm " + (ok ? "bg-emerald-50 border-emerald-100 text-emerald-800" : "bg-sky-50 border-sky-100 text-sky-800");
    box.innerHTML = ok ? `<b>âœ… æ­£ç¢ºï¼</b> ${text}` : `<b>å†æƒ³ä¸€ä¸‹ï¼š</b> ${text}`;
  }

  list.addEventListener("click", (ev)=>{
    const btn = ev.target.closest("button[data-idx]");
    if(!btn) return;
    const idx = Number(btn.dataset.idx);
    if(done[idx]) return;

    const pick = btn.dataset.pick;
    const ok = pick === cards[idx].correct;

    if(ok){
      done[idx] = true;
      sfxGood();
      showHint(idx, true, cards[idx].why);
      render();
    }else{
      sfxEncourage();
      showHint(idx, false, cards[idx].why);
    }
  });

  $("s3Reset").onclick = ()=>{
    done = Array(cards.length).fill(false);
    sfxBad();
    render();
  };

  render();
}

/* =========================
   Stage4ï¼ˆåš´æ ¼éµå®ˆï¼šä¸æ”¹ï¼‰
========================= */
function stage4(){
  openModal("ç¬¬ 4 é—œï½œå¯ç–‘äº¤æ˜“åµæ¸¬ï¼ˆæ”¾å¤§é¡ï¼‰", "å…ˆæŒ‰ ğŸ” çœ‹ç´°ç¯€ï¼Œå†é¸å‡ºã€æœ€å¯ç–‘ã€çš„ä¸€ç­†ï¼ˆ+40ï¼‰");

  const txs = [
    {
      id:1, title:"EcoCoin å…Œæ›ï¼šç’°ä¿æ¯",
      msg:"ä½ ä¸»å‹•å…Œæ› â†’ æ‰£ 120 EcoCoinã€‚",
      zoomTitle:"Tx #1 æ”¾å¤§é¡",
      zoomBody:`é€™ç­†æ˜¯ä½ ä¸»å‹•æ“ä½œï¼Œé‡‘é¡å›ºå®šã€æµç¨‹åˆç†ã€‚
âœ… çœ‹èµ·ä¾†æ­£å¸¸ï¼šæ²’æœ‰æ€¥è¿«å­—çœ¼ã€æ²’æœ‰ç„¡é™é¡æˆæ¬Šã€æ²’æœ‰é™Œç”Ÿç¶²åŸŸã€‚`,
      bad:false
    },
    {
      id:2, title:"App ä½¿ç”¨æˆæ¬Š",
      msg:"æˆæ¬Šç¯„åœï¼šåªè®€å–å¿…è¦è³‡è¨Šï¼ˆé™é¡ï¼‰ã€‚",
      zoomTitle:"Tx #2 æ”¾å¤§é¡",
      zoomBody:`æˆæ¬Šå…§å®¹æœ‰ç¯„åœé™åˆ¶ï¼Œä¸”æ˜¯å¿…è¦ç”¨é€”ã€‚
âœ… çœ‹èµ·ä¾†æ­£å¸¸ï¼šä¸æ˜¯ç„¡é™é¡ã€æ²’æœ‰è¦ä½ å…ˆä»˜è²»ã€‚`,
      bad:false
    },
    {
      id:3, title:"é™æ™‚é ˜çï¼šç°½åæˆæ¬Š",
      msg:"é¡¯ç¤ºï¼šApprove unlimited spendï¼ˆç„¡é™é¡ï¼‰",
      zoomTitle:"Tx #3 æ”¾å¤§é¡ï¼ˆæœ€å¯ç–‘ï¼‰",
      zoomBody:`âš ï¸ é€™ç­†æœ€å¯ç–‘çš„åœ°æ–¹ï¼š
1) å‡ºç¾ã€Œunlimited / ç„¡é™é¡ã€æˆæ¬Š
2) å¸¸æ­é…ã€Œé™æ™‚ã€å¿«é ˜ã€ç­‰æ€¥è¿«å­—çœ¼
3) ä½ ä¸æ˜¯ä¸»å‹•å…Œæ›ï¼Œå»è¦æˆæ¬Šå¾ˆå¤§æ¬Šé™

âœ… æ­£ç¢ºåšæ³•ï¼šå…ˆæ‹’çµ• â†’ å»å®˜æ–¹ä¾†æºç¢ºèª â†’ å¿…è¦æ‰åšã€é™é¡ã€æˆæ¬Šã€‚`,
      bad:true
    },
    {
      id:4, title:"æœ‹å‹åˆ†äº«æŠ•ç¥¨é€£çµ",
      msg:"ç¶²åŸŸé¡¯ç¤ºï¼šshort.link/xxxxï¼ˆç¸®ç¶²å€ï¼‰",
      zoomTitle:"Tx #4 æ”¾å¤§é¡",
      zoomBody:`å¯ç–‘é»ï¼šç¸®ç¶²å€çœ‹ä¸åˆ°çœŸæ­£ç¶²åŸŸï¼Œå¯èƒ½å°åˆ°é‡£é­šç«™ã€‚
âš ï¸ ä½†å®ƒçš„å±éšªç¨‹åº¦é€šå¸¸ä½æ–¼ã€Œç„¡é™é¡æˆæ¬Šã€é‚£ç¨®ç›´æ¥æ‹¿èµ°æ¬Šé™çš„ç‹€æ³ã€‚
âœ… åšæ³•ï¼šå…ˆæŸ¥çœŸæ­£ç¶²åŸŸã€ç¢ºèªå®˜æ–¹å†é»ã€‚`,
      bad:false
    },
  ];

  bodyHTML(`
    <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
      <div class="font-extrabold text-slate-900">ä»»å‹™</div>
      <div class="text-sm text-slate-700 mt-2">
        å…ˆæŒ‰æ¯ç­†çš„ ğŸ” çœ‹ç´°ç¯€æç¤ºï¼Œå†é¸å‡ºã€Œæœ€å¯ç–‘ã€çš„ä¸€ç­†ã€‚
      </div>
    </div>

    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3" id="s4Grid"></div>

    <div class="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
      <button id="btnFinish4" class="w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
        å°šæœªé¸å‡ºæœ€å¯ç–‘çš„ä¸€ç­†
      </button>
    </div>
  `);

  const grid = $("s4Grid");
  let zoomSeen = new Set();

  function openZoom(t){
    $("zoomTitle").textContent = t.zoomTitle;
    $("zoomSub").textContent = "å¯ç–‘ç´°ç¯€ï¼ˆçœ‹å®Œå†é¸ï¼‰";
    $("zoomBody").textContent = t.zoomBody;
    show($("zoomModal"));
    zoomSeen.add(t.id);
    sfxGood();
  }
  $("zoomClose").onclick = ()=> hide($("zoomModal"));
  $("zoomOk").onclick = ()=> hide($("zoomModal"));

  /* âœ…ï¼ˆv8#3ï¼‰é»ç©ºç™½è™•å³å¯é—œé–‰æ”¾å¤§é¡è¦–çª— */
  $("zoomModal").addEventListener("click", (e)=>{
    if(e.target === $("zoomModal") || e.target.classList.contains("modal-backdrop")){
      hide($("zoomModal"));
    }
  });

  txs.forEach(t=>{
    const wrap = document.createElement("div");
    wrap.className = "p-4 rounded-2xl bg-white border border-slate-200 card-hover";

    wrap.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs font-bold text-slate-500">Tx #${t.id}</div>
          <div class="mt-1 font-extrabold text-slate-900">${t.title}</div>
          <div class="mt-2 text-sm text-slate-700">${t.msg}</div>
        </div>
        <button class="w-12 h-12 rounded-2xl bg-slate-900 text-white font-black hover:bg-slate-800 text-xl shadow-soft" data-zoom="${t.id}" title="æ”¾å¤§é¡">ğŸ”</button>
      </div>
      <button class="mt-3 w-full px-3 py-3 rounded-2xl bg-slate-50 border border-slate-200 text-slate-800 font-extrabold hover:bg-white" data-pick="${t.id}">
        é¸é€™ç­†
      </button>
    `;
    grid.appendChild(wrap);
  });

  grid.addEventListener("click", (ev)=>{
    const zoomBtn = ev.target.closest("button[data-zoom]");
    if(zoomBtn){
      const id = Number(zoomBtn.dataset.zoom);
      const t = txs.find(x=>x.id === id);
      if(t) openZoom(t);
      return;
    }

    const pickBtn = ev.target.closest("button[data-pick]");
    if(pickBtn){
      const id = Number(pickBtn.dataset.pick);

      [...grid.children].forEach(c=> c.classList.remove("ring-4","ring-emerald-200"));
      pickBtn.closest("div").classList.add("ring-4","ring-emerald-200");

      const fin = $("btnFinish4");
      const picked = txs.find(x=>x.id === id);

      if(!zoomSeen.has(id)){
        sfxBad();
        fin.disabled = true;
        fin.className = "w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed";
        fin.textContent = "å…ˆæŒ‰é€™ç­†çš„ ğŸ” çœ‹ç´°ç¯€ï¼Œå†åšé¸æ“‡";
        return;
      }

      if(picked && picked.bad){
        sfxLevelUp();
        fin.disabled = false;
        fin.className = "w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700";
        fin.textContent = "é€šé—œï¼ˆé ˜å– +40ï¼‰â†’ å‰å¾€ç¬¬ 5 é—œ";
        fin.onclick = ()=>{
          addEco(40, "level4_reward");
          markCompleted(4);
          closeModal();
          jumpTo(5, 4);
        };
      }else{
        sfxEncourage();
        fin.disabled = true;
        fin.className = "w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed";
        fin.textContent = "é€™ç­†ä¸æ˜¯ã€æœ€å¯ç–‘ã€ï¼Œå†çœ‹çœ‹å…¶ä»–æ”¾å¤§é¡";
      }
    }
  });
}

/* =========================
   Stage5ï¼ˆåš´æ ¼éµå®ˆï¼šYA éŸ³æ•ˆ + å®Œæˆå¾Œæ…¶ç¥ï¼‰
========================= */
function stage5(){
  openModal("ç¬¬ 5 é—œï½œRWA å…¥é–€ï¼‹åˆ†é¡éŠæˆ²ï¼‹å…Œæ›", "å®Œæˆåˆ†é¡ä»»å‹™ï¼Œå†å®Œæˆä¸€æ¬¡å…Œæ›ï¼Œå³å¯éé—œï¼ˆ+50ï¼‰");

  bodyHTML(`
    <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
      <div class="font-extrabold text-slate-900">RWA è¶…ç™½è©±</div>
      <div class="mt-2 text-sm text-slate-700 leading-relaxed space-y-1">
        <div>â‘  RWA å°±æ˜¯ã€ŒæŠŠçœŸå¯¦ä¸–ç•Œçš„æ±è¥¿ï¼ˆæˆ¿å­ã€å‚µåˆ¸ã€ç¥¨åˆ¸â€¦ï¼‰è®Šæˆæ›´å¥½ç®¡ç†çš„æ•¸ä½æ†‘è­‰ã€ã€‚</div>
        <div>â‘¡ é‡é»ä¸æ˜¯ç‚«æŠ€ï¼Œè€Œæ˜¯ï¼šæ›´å¥½æŸ¥ã€å¯è¿½è¹¤ã€æµç¨‹æ›´æ¸…æ¥šã€‚</div>
        <div>â‘¢ çœ‹åˆ°é™Œç”Ÿé€£çµè¦ä½ å…ˆç°½å/å…ˆä»˜è²»ï¼Œä¸€æ¨£è¦å…ˆåœä¸‹ä¾†æŸ¥ä¾†æºã€‚</div>
      </div>
    </div>

    <div class="mt-4 p-4 rounded-2xl bg-white border border-slate-200">
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-slate-900">åˆ†é¡å°éŠæˆ²ï¼šé€™å€‹ç®—ä¸ç®— RWAï¼Ÿ</div>
        <div class="text-sm font-black text-slate-900">æ­£ç¢ºï¼š<span id="rwaScore">0</span>/6</div>
      </div>
      <p class="text-sm text-slate-600 mt-2">æ¯å¼µå¡é¸ä¸€æ¬¡ã€Œæ˜¯ RWAã€æˆ–ã€Œä¸æ˜¯ RWAã€ã€‚</p>
      <div id="rwaGrid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      <div id="rwaHint" class="mt-4 hidden p-4 rounded-2xl border"></div>
    </div>

    <div class="mt-4 p-4 rounded-2xl bg-amber-50 border border-amber-100">
      <div class="font-extrabold text-slate-900">å…Œæ›ä»»å‹™</div>
      <div class="text-sm text-slate-700 mt-2">
        åˆ†é¡é”æ¨™å¾Œï¼Œè«‹å®Œæˆä¸€æ¬¡å…Œæ›ï¼ˆç¤ºç¯„æ‰£å¹£ï¼‰ã€‚<br/>
        éœ€è¦ 120 EcoCoinï¼ˆç’°ä¿æ¯ï¼‰ã€‚
      </div>

      <button id="btnRedeem5" class="mt-3 w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
        éœ€è¦å…ˆå®Œæˆåˆ†é¡
      </button>

      <div id="redeemOut" class="mt-3 hidden p-4 rounded-2xl bg-white border border-amber-100 text-sm text-slate-700"></div>
    </div>

    <div class="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
      <button id="btnFinish5" class="w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed" disabled>
        å°šæœªå®Œæˆ
      </button>
    </div>
  `);

  const items = [
    { title:"æˆ¿å±‹ç”¢æ¬Šæ†‘è­‰ï¼ˆå¯æŸ¥é©—çš„æ•¸ä½æ†‘è­‰ï¼‰", isRWA:true,  why:"çœŸå¯¦ä¸–ç•Œçš„è³‡ç”¢ï¼ˆæˆ¿å­ï¼‰â†’ åšæˆå¯æŸ¥é©—çš„æ†‘è­‰ã€‚"},
    { title:"å‚µåˆ¸/ç¥¨åˆ¸çš„æ•¸ä½åŒ–æ†‘è­‰", isRWA:true,          why:"çœŸå¯¦ä¸–ç•Œçš„é‡‘èç¥¨åˆ¸ â†’ å¯è¿½è¹¤çš„æ†‘è­‰ã€‚"},
    { title:"ä¸€å¼µã€å¾ˆæ¼‚äº®çš„ JPG åœ–ç‰‡ã€", isRWA:false,     why:"åªæ˜¯åœ–ç‰‡ï¼Œä¸ä»£è¡¨çœŸå¯¦ä¸–ç•Œè³‡ç”¢ã€‚"},
    { title:"æ¼”å”±æœƒå¯¦é«”é–€ç¥¨çš„å¯é©—è­‰é›»å­ç¥¨", isRWA:true,   why:"çœŸå¯¦ä¸–ç•Œç¥¨åˆ¸ â†’ å¯é©—è­‰ã€å¯é˜²å½ã€‚"},
    { title:"é™Œç”Ÿäººç™¼çš„ã€é™æ™‚å¿«é ˜ã€é€£çµ", isRWA:false,     why:"é€™æ˜¯æƒ…å¢ƒ/é€£çµï¼Œä¸æ˜¯è³‡ç”¢æ†‘è­‰ã€‚"},
    { title:"å•†å“ä¿å›º/åºè™Ÿçš„å¯é©—è­‰æ†‘è­‰", isRWA:true,       why:"å°æ‡‰çœŸå¯¦å•†å“èˆ‡æ¬Šç›Š â†’ å¯é©—è­‰æ†‘è­‰ã€‚"},
  ];

  let answered = Array(items.length).fill(false);
  let score = 0;

  function setHint(ok, text){
    const box = $("rwaHint");
    box.classList.remove("hidden");
    box.className = "mt-4 p-4 rounded-2xl border " + (ok ? "bg-emerald-50 border-emerald-100" : "bg-sky-50 border-sky-100");
    box.innerHTML = `
      <div class="font-extrabold text-slate-900">${ok ? "ç­”å°" : "æé†’"}</div>
      <div class="text-sm text-slate-700 mt-2 leading-relaxed">${text}</div>
    `;
  }

  const grid = $("rwaGrid");
  items.forEach((it, idx)=>{
    const card = document.createElement("div");
    card.className = "p-4 rounded-2xl bg-slate-50 border border-slate-200";
    card.innerHTML = `
      <div class="font-extrabold text-slate-900">${it.title}</div>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <button data-idx="${idx}" data-ans="yes" class="px-3 py-3 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-slate-800">æ˜¯ RWA</button>
        <button data-idx="${idx}" data-ans="no" class="px-3 py-3 rounded-2xl bg-white border border-slate-200 text-slate-700 font-extrabold hover:bg-white">ä¸æ˜¯ RWA</button>
      </div>
      <div id="rwaDone${idx}" class="mt-3 hidden text-sm font-extrabold"></div>
    `;
    grid.appendChild(card);
  });

  grid.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-idx]");
    if(!btn) return;
    const idx = Number(btn.dataset.idx);
    if(answered[idx]) return;

    answered[idx] = true;
    const chooseYes = btn.dataset.ans === "yes";
    const ok = chooseYes === items[idx].isRWA;

    const out = $("rwaDone"+idx);
    out.classList.remove("hidden");
    out.textContent = ok ? "âœ… æ­£ç¢º" : "â— å†æƒ³ä¸€ä¸‹";
    out.className = ok ? "mt-3 text-sm font-extrabold text-emerald-700" : "mt-3 text-sm font-extrabold text-sky-700";

    btn.parentElement.querySelectorAll("button").forEach(b=>{
      b.disabled = true;
      b.className = b.className + " opacity-70 cursor-not-allowed";
    });

    if(ok){
      score++;
      sfxGood();
      setHint(true, items[idx].why);
    }else{
      sfxEncourage();
      setHint(false, items[idx].why);
    }
    setText("rwaScore", String(score));

    const doneCount = answered.filter(Boolean).length;
    if(doneCount === items.length){
      const redeemBtn = $("btnRedeem5");
      if(score >= 5){
        redeemBtn.disabled = false;
        redeemBtn.className = "mt-3 w-full px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-slate-800";
        redeemBtn.textContent = "é–‹å§‹å…Œæ›ï¼ˆæ‰£ 120 EcoCoinï¼‰";
      }else{
        redeemBtn.disabled = true;
        redeemBtn.className = "mt-3 w-full px-4 py-3 rounded-2xl bg-slate-300 text-slate-600 font-extrabold cursor-not-allowed";
        redeemBtn.textContent = "åˆ†é¡åˆ†æ•¸ä¸è¶³ï¼ˆéœ€è¦ 5/6ï¼‰";
      }
    }
  });

  let redeemed = false;
  $("btnRedeem5").onclick = ()=>{
    const box = $("redeemOut");
    box.classList.remove("hidden");
    const ok = spendEco(120, "level5_redeem_ecocup");
    if(!ok){
      sfxBad();
      box.innerHTML = `EcoCoin ä¸è¶³ï¼ˆéœ€è¦ 120ï¼‰ã€‚ä½ ç›®å‰æ˜¯ <b>${state.eco}</b>ã€‚å›å‰é¢é—œå¡æ‹¿å¹£å†ä¾†ã€‚`;
      return;
    }
    sfxLevelUp();
    box.innerHTML = `å…Œæ›æˆåŠŸ âœ… å·²æ‰£é™¤ 120 EcoCoinã€‚`;
    redeemed = true;

    const finish = $("btnFinish5");
    finish.disabled = false;
    finish.className = "w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700";
    finish.textContent = "å®Œæˆç¬¬ 5 é—œï¼ˆé ˜å– +50ï¼‰";
  };

  $("btnFinish5").onclick = ()=>{
    if(!redeemed) return;
    addEco(50, "level5_reward");
    markCompleted(5);

    sfxYA();
    closeModal();
    openCelebrate();
  };
}

/* =========================
   Stage registry
========================= */
const stages = { stage1, stage2, stage3, stage4, stage5 };

/* =========================
   âœ… EcoCup ç•ªå¤–ç¯‡ï¼ˆåƒ…æ–°å¢ï¼Œä¸å½±éŸ¿ 1~5 é—œï¼‰
========================= */
function openEcoCupIdea(){
  openModal("EcoCupï½œæ‰‹æå‹å–„è¨­è¨ˆ", "ç•ªå¤–ç¯‡ï¼šç”¨è¨­è¨ˆè§£æ±ºã€ä¸æƒ³å¸¶ã€çš„çœŸæ­£åŸå› ");

  bodyHTML(`
    <div id="ecoCupWrap" class="space-y-4">
      <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-100 text-slate-800 text-sm leading-relaxed">
        å¤šæ•¸äººä¸å¸¶ç’°ä¿æ¯ä¸æ˜¯ä¸ç’°ä¿ï¼Œè€Œæ˜¯<strong>æ‹¿è‘—éº»ç…©ã€å ç©ºé–“ã€æ€•æ¼</strong>ã€‚
        æˆ‘å€‘ç”¨ 4 å€‹åŸå‹æŠŠã€Œé¡˜æ„æ‰‹æã€è®ŠæˆçœŸçš„å¯ä»¥æ¯å¤©ç”¨ã€‚
      </div>

      <div class="grid grid-cols-1 gap-3">
        <div class="p-4 rounded-2xl bg-white border border-slate-200 eco-proto" style="animation-delay: 30ms">
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-2xl bg-emerald-50 border border-emerald-100 flex items-center justify-center text-lg">ğŸª¢</div>
            <div class="font-extrabold text-slate-900">â‘  æ‰‹æç’°æ¯è“‹</div>
          </div>
          <div class="text-sm text-slate-700 mt-2 leading-relaxed">
            æ¯è“‹å¤–åœˆåšæŸ”è»Ÿæç’°ï¼ˆä¸å‹’æ‰‹ï¼‰ï¼Œèµ°è·¯ä¹Ÿèƒ½æã€‚<br/>
            <span class="text-slate-500">ç‚ºä»€éº¼æœƒé¡˜æ„å¸¶ï¼šä¸å æ‰‹ã€ä¸ç”¨å¡åŒ…åŒ…ã€‚</span>
          </div>
        </div>

        <div class="p-4 rounded-2xl bg-white border border-slate-200 eco-proto" style="animation-delay: 70ms">
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-2xl bg-sky-50 border border-sky-100 flex items-center justify-center text-lg">ğŸ”’</div>
            <div class="font-extrabold text-slate-900">â‘¡ é˜²æ¼ï¼‹å–®æ‰‹é–‹</div>
          </div>
          <div class="text-sm text-slate-700 mt-2 leading-relaxed">
            æ—‹è½‰é–ï¼‹çŸ½è† å¯†å°ï¼Œé€šå‹¤æ™ƒä¹Ÿä¸æ»²ï¼›å–®æ‰‹èƒ½é–‹èƒ½å–ã€‚<br/>
            <span class="text-slate-500">ç‚ºä»€éº¼æœƒé¡˜æ„å¸¶ï¼šæ¼ä¸€æ¬¡å°±ä¸æƒ³ç”¨ï¼Œå…ˆæŠŠç—›é»è§£æ‰ã€‚</span>
          </div>
        </div>

        <div class="p-4 rounded-2xl bg-white border border-slate-200 eco-proto" style="animation-delay: 110ms">
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-2xl bg-amber-50 border border-amber-100 flex items-center justify-center text-lg">ğŸ§©</div>
            <div class="font-extrabold text-slate-900">â‘¢ å¯æŠ˜ç–Šï¼ç¸®çŸ­æ¯èº«</div>
          </div>
          <div class="text-sm text-slate-700 mt-2 leading-relaxed">
            å–å®Œå¯ç¸®çŸ­é«˜åº¦æˆ–æŠ˜ç–Šæ”¶ç´ï¼Œç©ºæ¯ä¹Ÿä¸å ç©ºé–“ã€‚<br/>
            <span class="text-slate-500">ç‚ºä»€éº¼æœƒé¡˜æ„å¸¶ï¼šä¸ç”¨ç‚ºäº†ã€Œç©ºæ¯ã€å¤šèƒŒä¸€å€‹æ±è¥¿ã€‚</span>
          </div>
        </div>

        <div class="p-4 rounded-2xl bg-white border border-slate-200 eco-proto" style="animation-delay: 150ms">
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-2xl bg-violet-50 border border-violet-100 flex items-center justify-center text-lg">ğŸ§¤</div>
            <div class="font-extrabold text-slate-900">â‘£ æ¯å¥—å¤šåŠŸèƒ½åŒ–</div>
          </div>
          <div class="text-sm text-slate-700 mt-2 leading-relaxed">
            æ¯å¥—ï¼éš”ç†±ï¼‹ææŠŠï¼‹å¥½çœ‹ï¼Œè®“å®ƒæ›´åƒã€Œé¡˜æ„æ‹¿å‡ºé–€ã€çš„éš¨èº«ç‰©ã€‚<br/>
            <span class="text-slate-500">ç‚ºä»€éº¼æœƒé¡˜æ„å¸¶ï¼šæ‰‹æ„Ÿï¼‹å¤–è§€ä¸€å¥½ï¼Œå°±æ›´åƒæ—¥å¸¸é…ä»¶ã€‚</span>
          </div>
        </div>
      </div>

      <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
        <div class="font-extrabold text-slate-900">ğŸ’¬ ä½ æœ€æƒ³è¦å“ªä¸€ç¨®è¨­è¨ˆï¼Ÿï¼ˆé»ä¸€ä¸‹ï¼‰</div>
        <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
          <button class="eco-choice px-3 py-3 rounded-2xl font-extrabold text-slate-800" data-pick="1">â‘  æ‰‹æç’°</button>
          <button class="eco-choice px-3 py-3 rounded-2xl font-extrabold text-slate-800" data-pick="2">â‘¡ é˜²æ¼</button>
          <button class="eco-choice px-3 py-3 rounded-2xl font-extrabold text-slate-800" data-pick="3">â‘¢ å¯æŠ˜ç–Š</button>
          <button class="eco-choice px-3 py-3 rounded-2xl font-extrabold text-slate-800" data-pick="4">â‘£ æ¯å¥—</button>
        </div>
        <div id="ecoVoteMsg" class="mt-3 hidden p-3 rounded-2xl bg-emerald-50 border border-emerald-100 text-sm text-emerald-800"></div>
      </div>

      <div class="text-xs text-slate-500">
        å ±å‘Šå£æ¢å°å¥ï¼šæˆ‘å€‘ä¸æ˜¯åªå–Šç’°ä¿ï¼Œè€Œæ˜¯æŠŠã€Œé¡˜æ„æ‰‹æã€æ‹†æˆå¯è½åœ°çš„è¨­è¨ˆè§£æ³•ï¼Œé™ä½è¡Œç‚ºé–€æª»ã€‚
      </div>
    </div>
  `);

  const wrap = $("ecoCupWrap");
  const msg = $("ecoVoteMsg");
  const mapText = { "1":"æ‰‹æç’°æ¯è“‹", "2":"é˜²æ¼ï¼‹å–®æ‰‹é–‹", "3":"å¯æŠ˜ç–Šï¼ç¸®çŸ­", "4":"æ¯å¥—å¤šåŠŸèƒ½" };

  wrap.querySelectorAll(".eco-choice").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      wrap.querySelectorAll(".eco-choice").forEach(b=>{
        b.classList.remove("selected","pulse");
      });
      btn.classList.add("selected","pulse");
      setTimeout(()=> btn.classList.remove("pulse"), 320);

      msg.classList.remove("hidden");
      msg.innerHTML = `ä½ é¸çš„æ˜¯ <b>${mapText[btn.dataset.pick]}</b> âœ…ï¼ˆé€™å€‹åŸå‹æœ€èƒ½è§£æ±ºã€Œä¸æƒ³å¸¶ã€çš„ç—›é»ä¹‹ä¸€ï¼‰`;

      try { sfxGood(); } catch(e) {}
    });
  });
}

/* =========================
   Global events
========================= */
$("modalClose").addEventListener("click", closeModal);

$("btnReset").addEventListener("click", ()=>{
  stopTTS();
  if(confirm("ç¢ºå®šè¦é‡ç½®é€²åº¦èˆ‡ EcoCoin å—ï¼Ÿï¼ˆä¸æœƒæ¸…é™¤æš±ç¨±ï¼‰")){
    localStorage.removeItem(STORAGE_KEY);
    state = defaultState();
    saveState();
    renderEco();
    updateBadges();
    alert("å·²é‡ç½® âœ…");
  }
});

// Map buttons
$("lv1").addEventListener("click", ()=> stages.stage1());
$("lv2").addEventListener("click", ()=>{ if(state.completed[1]) stages.stage2(); });
$("lv3").addEventListener("click", ()=>{ if(state.completed[2]) stages.stage3(); });
$("lv4").addEventListener("click", ()=>{ if(state.completed[3]) stages.stage4(); });
$("lv5").addEventListener("click", ()=>{ if(state.completed[4]) stages.stage5(); });

// âœ… EcoCup å…¥å£æŒ‰éˆ•ï¼ˆåƒ…æ–°å¢ï¼‰
const ecoBtn = document.getElementById("btnEcoCupIdea");
if(ecoBtn) ecoBtn.addEventListener("click", openEcoCupIdea);

// unlock audio context on first interaction
window.addEventListener("pointerdown", ()=>{ ensureAudio(); }, { once:false });

/* =========================
   âœ… Nick start logic + Change nickname
========================= */
const startBtn = document.getElementById("btnStartGame");
const nickInput = document.getElementById("nicknameInput");
const nickPrev = document.getElementById("nickPreview");
const nickErr = document.getElementById("nickErr");

function normalizeNick(s){
  return (s || "").trim();
}

if(nickInput && nickPrev){
  nickInput.addEventListener("input", ()=>{
    nickPrev.textContent = normalizeNick(nickInput.value) || "å†’éšªè€…";
  }, { passive:true });
}

if(startBtn){
  startBtn.addEventListener("click", ()=>{
    ensureAudio();
    const n = normalizeNick(nickInput ? nickInput.value : "");
    if(!n){
      if(nickErr){
        nickErr.classList.remove("hidden");
        nickErr.textContent = "è«‹å…ˆè¼¸å…¥æš±ç¨±å†é–‹å§‹ï½";
      }
      sfxEncourage();
      return;
    }
    setNick(n);
    applyNickToUI();
    hideStartOverlay();
    sfxLevelUp();
  });
}

const btnChangeNick = document.getElementById("btnChangeNick");
if(btnChangeNick){
  btnChangeNick.addEventListener("click", ()=>{
    ensureAudio();
    localStorage.removeItem(NICK_KEY);
    applyNickToUI();
    showStartOverlay();
  });
}

/* =========================
   Initial render
========================= */
renderEco();
updateBadges();
applyNickToUI();

// é¦–æ¬¡ï¼šå¦‚æœæ²’æœ‰æš±ç¨±å°±è¦æ±‚è¼¸å…¥ä¸€æ¬¡
if(!getNick()){
  showStartOverlay();
} else {
  hideStartOverlay();
}
</script>

</body>
</html>
